var I=Object.defineProperty;var z=(L,t,r)=>t in L?I(L,t,{enumerable:!0,configurable:!0,writable:!0,value:r}):L[t]=r;var B=(L,t,r)=>(z(L,typeof t!="symbol"?t+"":t,r),r);import{p as k,a as A}from"./6cc4f5807f5417d76ffd6252058f18a5.js";import{l as O}from"./798d77a2cc0b06947e326ec57ac79867.js";import{r as $,u as N}from"./a249de61d26fa0e9c55cd1a997b2f3fc.js";import{E as _}from"./1ef827d78758f1cc260efc1cc487bd6a.js";import"./a0cfba98480a8e27227569d9f5f13dff.js";import{J as j}from"./a2d51818e134dfda6f32266bb36e093e.js";import{c as U}from"./5b6d41c8f3d086816edf7147d0e5be66.js";import{bf as W}from"./ead41015014512fa5b1aedaebaed4448.js";k.GlobalWorkerOptions.workerSrc=A;const T=class T{_pdfDoc=null;pageRendering=!1;pageNumPending=null;_scale=1.5;memoryWarningThreshold=150*1024*1024;constructor(){this.startMemoryMonitoring()}static getInstance(){return T.instance||(T.instance=new T),T.instance}get scale(){return this._scale}set scale(t){t>0&&(this._scale=t)}startMemoryMonitoring(){window.performance&&performance.memory&&setInterval(()=>{const r=performance.memory.usedJSHeapSize;r>this.memoryWarningThreshold&&(console.warn("Memory usage warning:",Math.round(r/1024/1024),"MB"),this.triggerMemoryCleanup())},5e3)}async triggerMemoryCleanup(){try{Array.from(document.getElementsByTagName("canvas")).forEach(a=>{document.body.contains(a)||this.cleanupCanvas(a)}),performance.getEntriesByType("resource").forEach(a=>{a.name.startsWith("blob:")&&!document.querySelector(`[src="${a.name}"]`)&&URL.revokeObjectURL(a.name)}),Array.from(document.getElementsByTagName("img")).forEach(a=>{!document.body.contains(a)&&(a.src.startsWith("blob:")||a.src.startsWith("data:"))&&URL.revokeObjectURL(a.src)}),window.gc&&window.gc()}catch(t){console.error("Error during memory cleanup:",t)}}async trackMemoryUsage(t){var l,a;const r=(l=performance.memory)==null?void 0:l.usedJSHeapSize;try{return await t()}finally{const h=(a=performance.memory)==null?void 0:a.usedJSHeapSize;if(r&&h){const o=h-r;o>10*1024*1024&&console.warn(`Memory usage increased by ${Math.round(o/1024/1024)}MB`)}}}async convertDocxToPdf(t){const r=document.createElement("div");try{const a={arrayBuffer:await t.arrayBuffer(),styleMap:["p[style-name='Title'] => h1:fresh","p[style-name='Heading 1'] => h1:fresh","p[style-name='Heading 2'] => h2:fresh","p[style-name='Heading 3'] => h3:fresh","p[style-name='heading 1'] => h1:fresh","p[style-name='heading 2'] => h2:fresh","p[style-name='heading 3'] => h3:fresh","p[style-name='List Paragraph'] => li:fresh","p[style-name='List Bullet'] => li:fresh","p[style-name='List Number'] => li:fresh","p[style-name='listparagraph'] => li:fresh","p[style-name='bullet'] => li:fresh","p[style-name='numbered'] => li:fresh","table => table.docx-table","tr => tr.docx-tr","td => td.docx-td","th => th.docx-th","u => u","strike => s","b => strong","i => em","r[style-name='Strong'] => strong","r[style-name='Emphasis'] => em","p[style-name='Quote'] => blockquote:fresh","p[style-name='Intense Quote'] => blockquote.intense:fresh","p[style-name='Subtitle'] => h2:fresh","p[style-name='Caption'] => figcaption:fresh","r[style-name='Hyperlink'] => a","p[style-name='Code'] => pre:fresh > code:fresh","p[style-name='No Spacing'] => p.no-spacing:fresh","pic:pic => img:fresh","w:drawing => img:fresh","p[style-name='List Bullet 2'] => li.bullet-2:fresh","p[style-name='List Bullet 3'] => li.bullet-3:fresh","p[style-name='List Number 2'] => li.number-2:fresh","p[style-name='List Number 3'] => li.number-3:fresh","p[style-name='Table Header'] => th:fresh","p[style-name='Table Content'] => td:fresh","p[style-name='Footer'] => footer:fresh","p[style-name='Header'] => header:fresh","r[style-name='Subscript'] => sub","r[style-name='Superscript'] => sup","p[style-name='Note'] => div.note:fresh","r[style-name='Highlight'] => mark"],transformDocument:e=>{if(e.type==="table"&&(e.styleId="docx-table",e.children.forEach(i=>{i.type==="tableRow"&&(i.styleId="docx-tr",i.children.forEach(u=>{u.type==="tableCell"&&(u.styleId="docx-td")}))})),e.type==="paragraph"&&e.numbering){const i=e.numbering.level||0,u=e.numbering.isOrdered;e.type="list-item",e.listLevel=i,e.isOrdered=u,i>0&&(e.styleId=`list-level-${i}`),e.numbering.start!==void 0&&(e.listStart=e.numbering.start)}return e.type==="image"&&(e.styleId="docx-image",e.altText&&(e.alt=e.altText),e.title&&(e.title=e.title)),e}},h=await O.convertToHtml(a),o=new _({unit:"pt",format:"a4",orientation:"portrait"}),f=`${U.extension_dir}/assets/fonts/NotoSans-Regular.ttf`,m=`${U.extension_dir}/assets/fonts/NotoSans-Bold.ttf`,b=async e=>{const u=await(await fetch(e)).arrayBuffer();return x(u)},x=e=>{let i="";const u=new Uint8Array(e),S=u.byteLength;for(let F=0;F<S;F++)i+=String.fromCharCode(u[F]);return window.btoa(i)};try{const e=await b(f),i=await b(m);o.addFileToVFS("NotoSans-Regular-normal.ttf",e),o.addFileToVFS("NotoSans-Bold-normal.ttf",i),o.addFont("NotoSans-Regular-normal.ttf","NotoSans","normal"),o.addFont("NotoSans-Bold-normal.ttf","NotoSans","bold"),o.setFont("NotoSans")}catch(e){console.error("Error loading fonts:",e),o.setFont("times","normal")}r.innerHTML=h.value,r.style.width="595px",r.style.position="absolute",r.style.left="-9999px",r.style.fontFamily="Arial",r.style.fontSize="12px",document.body.appendChild(r);let s=40;const d=40,g=595,w=842,n=g-2*d;let c=0,p=1;const C=async e=>{const i=e.tagName==="OL",u=e.getElementsByTagName("li");for(let S=0;S<u.length;S++){const P=u[S].textContent||"",D=c*20;let v=i?`${p}. `:"â€¢ ";i&&p++;const M=n-D-20,R=o.splitTextToSize(P,M);s+R.length*15>w-d&&(o.addPage(),s=d),o.setFontSize(12),o.setFont("NotoSans","normal"),o.text(v,d+D,s),o.text(R,d+D+20,s),s+=R.length*15+5}s+=10},y=async e=>new Promise(i=>{const u=()=>{try{const S=e.src;if(!S.startsWith("data:")){console.error("Invalid image data"),i();return}const F=e.naturalWidth/e.naturalHeight,P=n,v=Math.min(e.naturalWidth,P)/F;s+v>w-d&&(o.addPage(),s=d);const M=S.match(/^data:image\/(\w+);base64,/);if(!M){console.error("Invalid image format"),i();return}const R=M[1].toUpperCase();s+=v+20,i()}catch(S){console.error("Error adding image to PDF:",S),i()}};e.complete?u():(e.onload=u,e.onerror=()=>{console.error("Error loading image"),i()})}),E=async e=>{const i=Array.from(e.rows).map(P=>Array.from(P.cells).map(D=>{var v;return((v=D.textContent)==null?void 0:v.trim())||""})),u=Math.max(...i.map(P=>P.length)),S=n/u,F={};for(let P=0;P<u;P++)F[P]={cellWidth:S};await o.autoTable({head:[i[0]],body:i.slice(1),startY:s,margin:{left:d,right:d},columnStyles:F,styles:{fontSize:10,cellPadding:5,overflow:"linebreak",halign:"left",font:"NotoSans"},headStyles:{fillColor:[240,240,240],textColor:[0,0,0],fontStyle:"bold",font:"NotoSans"}}),s=o.lastAutoTable.finalY+10};for(const e of Array.from(r.children)){if(e instanceof HTMLUListElement||e instanceof HTMLOListElement){await C(e);continue}if(e instanceof HTMLTableElement){await E(e);continue}const i=e.textContent||"",u=e.tagName.toLowerCase();u==="h1"?(o.setFontSize(24),o.setFont("NotoSans","bold")):u==="h2"?(o.setFontSize(20),o.setFont("NotoSans","bold")):u==="h3"?(o.setFontSize(16),o.setFont("NotoSans","bold")):(o.setFontSize(12),o.setFont("NotoSans","normal"));const S=o.splitTextToSize(i,n);s+S.length*12>w-d&&(o.addPage(),s=d),o.text(S,d,s),s+=S.length*(u.startsWith("h")?30:20)}return r.parentNode&&document.body.removeChild(r),new Uint8Array(o.output("arraybuffer"))}catch(l){throw console.error("Error converting DOCX to PDF:",l),new Error("Failed to convert DOCX to PDF")}}async convertExcelToPdf(t){try{const r=await t.arrayBuffer(),l=$(r,{type:"array"}),a=new _({unit:"pt",format:"a4",orientation:"landscape"});for(let h=0;h<l.SheetNames.length;h++){const o=l.SheetNames[h],f=l.Sheets[o],m=N.decode_range(f["!ref"]||"A1"),b=[],x=[];for(let n=m.s.c;n<=m.e.c;n++){let c=0;for(let p=m.s.r;p<=m.e.r;p++){const C=N.encode_cell({r:p,c:n}),y=f[C];if(y){const E=y.w||(y.v!==void 0?y.v.toString():"");c=Math.max(c,E.length)}}x[n]=Math.min(Math.max(c*7,50),200)}for(let n=m.s.r;n<=m.e.r;n++){const c=[];for(let p=m.s.c;p<=m.e.c;p++){const C=N.encode_cell({r:n,c:p}),y=f[C],E=(y==null?void 0:y.s)||{};let e="",i={fontStyle:"normal",halign:"left",fillColor:void 0,textColor:[0,0,0],fontSize:10};if(y){switch(y.t){case"n":e=typeof y.w<"u"?y.w:y.v.toString(),i.halign="right";break;case"b":e=y.v?"TRUE":"FALSE",i.halign="center";break;case"d":e=y.w||new Date(y.v).toLocaleDateString(),i.halign="right";break;case"s":case"str":e=y.v;break;default:e=y.w||""}E.fgColor&&(i.fillColor=[240,240,240]),E.bold&&(i.fontStyle="bold"),E.italic&&(i.fontStyle="italic")}c.push({content:e,styles:i})}b.push(c)}h>0&&a.addPage(),a.setFont("helvetica","bold"),a.setFontSize(16),a.text(o,40,40);const s=a.internal.pageSize.width,d=x.reduce((n,c)=>n+c,0),g=Math.max(40,(s-d)/2),w={};x.forEach((n,c)=>{w[c]={cellWidth:n}}),b.length>0&&await a.autoTable({head:[b[0]],body:b.slice(1),startY:60,margin:{left:g,right:g},columnStyles:w,styles:{fontSize:10,cellPadding:6,overflow:"linebreak",font:"helvetica",lineWidth:.5,lineColor:[80,80,80]},headStyles:{fillColor:[240,240,240],textColor:[0,0,0],fontStyle:"bold",fontSize:11,cellPadding:8,halign:"center",valign:"middle",lineWidth:1,lineColor:[60,60,60]},alternateRowStyles:{fillColor:[248,248,248]},didParseCell:function(n){const c=n.row.raw[n.column];c&&c.styles&&(Object.assign(n.cell.styles,c.styles),n.row.index===0&&(n.cell.styles.fontStyle="bold",n.cell.styles.fontSize=11,n.cell.styles.cellPadding=8))},willDrawCell:function(n){if(n.row.index===0){const c=n.doc,p=n.cell.styles.fillColor;if(p){const C=n.cell.x,y=n.cell.y,E=n.cell.width,e=n.cell.height;c.setFillColor(p[0],p[1],p[2]),c.rect(C,y,E,e,"F")}}}})}return new Uint8Array(a.output("arraybuffer"))}catch(r){throw console.error("Error converting Excel to PDF:",r),new Error("Failed to convert Excel to PDF")}}async convertPptToPdf(t){try{let r=function(b){const x=b.match(/<p:bg[^>]*>[\s\S]*?<a:solidFill>[\s\S]*?<a:srgbClr[^>]*val="([0-9A-Fa-f]{6})"/);if(!x)return null;const s=x[1],d=parseInt(s.substring(0,2),16),g=parseInt(s.substring(2,4),16),w=parseInt(s.substring(4,6),16);return{r:d,g,b:w}},l=function(b){return[...b.matchAll(/<a:t[^>]*>([\s\S]*?)<\/a:t>/g)].map(s=>s[1].trim()).filter(Boolean)};const a=await t.arrayBuffer(),h=await j.loadAsync(a),o=Object.keys(h.files).filter(b=>/^ppt\/slides\/slide\d+\.xml$/.test(b));o.sort((b,x)=>{var g,w;const s=parseInt(((g=b.match(/slide(\d+)\.xml$/))==null?void 0:g[1])||"0",10),d=parseInt(((w=x.match(/slide(\d+)\.xml$/))==null?void 0:w[1])||"0",10);return s-d});const f=new _({unit:"pt",format:"letter",orientation:"landscape"});let m=!0;for(const b of o){const x=await h.files[b].async("string"),s=r(x),d=l(x);m||f.addPage(),m=!1;const g=f.internal.pageSize.getWidth(),w=f.internal.pageSize.getHeight();s?(f.setFillColor(s.r,s.g,s.b),f.rect(0,0,g,w,"F")):(f.setFillColor(255,255,255),f.rect(0,0,g,w,"F")),f.setFont("helvetica","normal"),f.setFontSize(12);let n=60;const c=16,p=50,C=g-p*2;for(const y of d){const E=f.splitTextToSize(y,C);n+E.length*c>w-50&&(f.addPage(),s?(f.setFillColor(s.r,s.g,s.b),f.rect(0,0,g,w,"F")):(f.setFillColor(255,255,255),f.rect(0,0,g,w,"F")),n=60),f.text(E,p,n),n+=E.length*c+c}}return new Uint8Array(f.output("arraybuffer"))}catch(r){throw console.error("Error converting PPT/PPTX to PDF:",r),new Error("Failed to convert PPT/PPTX to PDF")}}async loadPDF(t){try{console.log("Loading PDF");let r;if(t.type.includes("pdf")){const a=await t.arrayBuffer();r=new Uint8Array(a)}else if(t.type.includes("wordprocessingml.document")||t.type.includes("msword"))r=await this.convertDocxToPdf(t);else if(t.type.includes("spreadsheetml.sheet")||t.type.includes("ms-excel"))r=await this.convertExcelToPdf(t);else if(t.type.includes("presentationml")||t.type.includes("ms-powerpoint"))r=await this.convertPptToPdf(t);else throw new Error("Unsupported file type");const l=k.getDocument({data:r});this._pdfDoc=W(await l.promise)}catch(r){throw await this.cleanup(),r}}get numPages(){const t=this.getPdfDoc();return t?t.numPages:0}getPdfDoc(){return this._pdfDoc?W(this._pdfDoc):null}async renderPage(t,r=this.scale,l=!1){return this.trackMemoryUsage(async()=>{const a=this.getPdfDoc();if(!a)throw new Error("Document not loaded");if(t<=0||t>a.numPages)throw new Error("Invalid page number");let h=null,o=null,f=null;try{h=await a.getPage(t);const m=l?1:window.devicePixelRatio||1,b=h.getViewport({scale:1});let x;if(l){const n=72*m,c=96*m,p=n/b.width,C=c/b.height;x=Math.min(p,C)}else x=r*m;const s=h.getViewport({scale:x}),d=document.createElement("div");d.className=l?"pdf-thumbnail-container":"pdf-page-container",l&&(d.style.width="72px",d.style.height="96px"),o=document.createElement("canvas");const g=o.getContext("2d",{alpha:!1,willReadFrequently:!1,desynchronized:!0});if(!g)throw new Error("Unable to get canvas context");if(o.width=Math.ceil(s.width),o.height=Math.ceil(s.height),l){const n=s.width/s.height,c=72/96;if(n>c){o.style.width="72px";const p=Math.round(72/n);o.style.height=`${p}px`,o.style.marginTop=`${Math.max(0,(96-p)/2)}px`}else{o.style.height="96px";const p=Math.round(96*n);o.style.width=`${p}px`,o.style.marginLeft=`${Math.max(0,(72-p)/2)}px`}}else o.style.width=`${s.width/m}px`,o.style.height=`${s.height/m}px`;g.imageSmoothingEnabled=!0,g.imageSmoothingQuality="high",g.fillStyle="white",g.fillRect(0,0,o.width,o.height),d.appendChild(o);let w;if(l){await h.render({canvasContext:g,viewport:s,intent:"display"}).promise;const n=o.toDataURL("image/jpeg",.8),c=document.createElement("img");c.src=n,c.style.width="100%",c.style.height="100%",c.style.objectFit="contain",d.innerHTML="",d.appendChild(c),w={container:d,width:72,height:96}}else{f=document.createElement("div"),f.className="pdf-text-layer",f.style.setProperty("--scale-factor",r.toString()),d.appendChild(f);const n=await h.getTextContent(),c=k.renderTextLayer({textContentSource:n,container:f,viewport:h.getViewport({scale:r}),textDivs:[]}),p=h.render({canvasContext:g,viewport:s,intent:"display"});await Promise.all([p.promise,c.promise]),w={container:d,width:s.width/m,height:s.height/m}}return w}catch(m){throw console.error("Error in renderPage:",m),m}finally{if(h)try{await h.cleanup()}catch(m){console.error("Error during page cleanup:",m)}}})}async cleanup(){try{if(this._pdfDoc){try{const t=this._pdfDoc.numPages,r=[];for(let l=1;l<=t;l++)r.push((async()=>{try{const a=await this._pdfDoc.getPage(l);if(a){const h=await a.getTextContent();h&&(h.items&&(h.items.length=0),Object.keys(h).forEach(o=>{h[o]=null})),a._transport&&await a._transport.cleanup(),a._intentStates&&a._intentStates.clear(),await a.cleanup()}}catch(a){console.error(`Error cleaning up page ${l}:`,a)}})());await Promise.all(r)}catch(t){console.error("Error cleaning up pages:",t)}try{this._pdfDoc._transport&&(await this._pdfDoc._transport.destroy(),this._pdfDoc._transport=null),this._pdfDoc._worker&&(await this._pdfDoc._worker.destroy(),this._pdfDoc._worker=null),await this._pdfDoc.destroy()}catch(t){console.error("Error destroying PDF document:",t)}this._pdfDoc=null}if(this.pageRendering=!1,this.pageNumPending=null,this._scale=1.5,k.GlobalWorkerOptions)try{const t=k.GlobalWorkerOptions.workerSrc;t&&typeof t=="string"&&URL.revokeObjectURL(t)}catch(t){console.error("Error cleaning up worker:",t)}try{Array.from(document.querySelectorAll('img[src^="blob:"], img[src^="data:"]')).forEach(l=>{l.src&&URL.revokeObjectURL(l.src)}),Array.from(document.getElementsByTagName("canvas")).forEach(l=>this.cleanupCanvas(l)),window.performance&&window.performance.memory&&performance.getEntriesByType("resource").forEach(a=>{a.name.startsWith("blob:")&&URL.revokeObjectURL(a.name)})}catch(t){console.error("Error cleaning up resources:",t)}if(window.gc)try{window.gc()}catch(t){console.error("Error forcing garbage collection:",t)}}catch(t){console.error("Error during cleanup:",t),this._pdfDoc=null,this.pageRendering=!1,this.pageNumPending=null}}cleanupCanvas(t){if(t)try{const r=t.getContext("2d");if(r){r.clearRect(0,0,t.width,t.height);const l=t.toDataURL();l&&URL.revokeObjectURL(l),r.canvas=null}t.width=1,t.height=1,t.oncontextmenu=null,t.onmousemove=null,t.onclick=null,t.onmousedown=null,t.onmouseup=null}catch(r){console.error("Error cleaning up canvas:",r)}}};B(T,"instance",null);let H=T;export{H as F};
