var __create=Object.create,__freeze=Object.freeze,__defProp=Object.defineProperty,__defProps=Object.defineProperties,__getOwnPropDesc=Object.getOwnPropertyDescriptor,__getOwnPropDescs=Object.getOwnPropertyDescriptors,__getOwnPropNames=Object.getOwnPropertyNames,__getOwnPropSymbols=Object.getOwnPropertySymbols,__getProtoOf=Object.getPrototypeOf,__hasOwnProp=Object.prototype.hasOwnProperty,__propIsEnum=Object.prototype.propertyIsEnumerable,__defNormalProp=(e,t,n)=>t in e?__defProp(e,t,{enumerable:!0,configurable:!0,writable:!0,value:n}):e[t]=n,__spreadValues=(e,t)=>{for(var n in t||(t={}))__hasOwnProp.call(t,n)&&__defNormalProp(e,n,t[n]);if(__getOwnPropSymbols)for(var n of __getOwnPropSymbols(t))__propIsEnum.call(t,n)&&__defNormalProp(e,n,t[n]);return e},__spreadProps=(e,t)=>__defProps(e,__getOwnPropDescs(t)),__commonJS=(e,t)=>function(){return t||(0,e[__getOwnPropNames(e)[0]])((t={exports:{}}).exports,t),t.exports},__copyProps=(e,t,n,r)=>{if(t&&"object"==typeof t||"function"==typeof t)for(let a of __getOwnPropNames(t))__hasOwnProp.call(e,a)||a===n||__defProp(e,a,{get:()=>t[a],enumerable:!(r=__getOwnPropDesc(t,a))||r.enumerable});return e},__toESM=(e,t,n)=>(n=null!=e?__create(__getProtoOf(e)):{},__copyProps(!t&&e&&e.__esModule?n:__defProp(n,"default",{value:e,enumerable:!0}),e)),__template=(e,t)=>__freeze(__defProp(e,"raw",{value:__freeze(t||e.slice())})),require_tflite=__commonJS({"src/tflite/tflite.js"(e,t){"use strict";var n,r=(n="undefined"!=typeof document&&document.currentScript?document.currentScript.src:void 0,function(e){var t,r,a=void 0!==(e=e||{})?e:{};a.ready=new Promise((function(e,n){t=e,r=n}));var o,i={};for(o in a)a.hasOwnProperty(o)&&(i[o]=a[o]);var u=[],s="./this.program",c=function(e,t){throw t},l="";"undefined"!=typeof document&&document.currentScript&&(l=document.currentScript.src),n&&(l=n),l=0!==l.indexOf("blob:")?l.substr(0,l.lastIndexOf("/")+1):"";var f,d=a.print||console.log.bind(console),m=a.printErr||console.warn.bind(console);for(o in i)i.hasOwnProperty(o)&&(a[o]=i[o]);i=null,a.arguments&&(u=a.arguments),a.thisProgram&&(s=a.thisProgram),a.quit&&(c=a.quit),a.wasmBinary&&(f=a.wasmBinary);var g,_=a.noExitRuntime||!0;"object"!=typeof WebAssembly&&M("no native wasm support detected");var p,E,h,T,A=!1,v="undefined"!=typeof TextDecoder?new TextDecoder("utf8"):void 0;function R(e,t,n){for(var r=t+n,a=t;e[a]&&!(a>=r);)++a;if(a-t>16&&e.subarray&&v)return v.decode(e.subarray(t,a));for(var o="";t<a;){var i=e[t++];if(128&i){var u=63&e[t++];if(192!=(224&i)){var s=63&e[t++];if((i=224==(240&i)?(15&i)<<12|u<<6|s:(7&i)<<18|u<<12|s<<6|63&e[t++])<65536)o+=String.fromCharCode(i);else{var c=i-65536;o+=String.fromCharCode(55296|c>>10,56320|1023&c)}}else o+=String.fromCharCode((31&i)<<6|u)}else o+=String.fromCharCode(i)}return o}function b(e){p=e,a.HEAP8=E=new Int8Array(e),a.HEAP16=new Int16Array(e),a.HEAP32=T=new Int32Array(e),a.HEAPU8=h=new Uint8Array(e),a.HEAPU16=new Uint16Array(e),a.HEAPU32=new Uint32Array(e),a.HEAPF32=new Float32Array(e),a.HEAPF64=new Float64Array(e)}a.INITIAL_MEMORY;var S,C=[],F=[],P=[],x=[];F.push({func:function(){V()}});var y=0,w=null,U=null;function M(e){a.onAbort&&a.onAbort(e),m(e+=""),A=!0,e="abort("+e+"). Build with -s ASSERTIONS=1 for more info.";var t=new WebAssembly.RuntimeError(e);throw r(t),t}function I(e){return t=e,n="data:application/octet-stream;base64,",String.prototype.startsWith?t.startsWith(n):0===t.indexOf(n);var t,n}a.preloadedImages={},a.preloadedAudios={};var L,B,O="tflite.wasm";function N(e){try{if(e==O&&f)return new Uint8Array(f);throw"both async and sync fetching of the wasm failed"}catch(e){M(e)}}function D(e){for(;e.length>0;){var t=e.shift();if("function"!=typeof t){var n=t.func;"number"==typeof n?void 0===t.arg?S.get(n)():S.get(n)(t.arg):n(void 0===t.arg?null:t.arg)}else t(a)}}function G(e){return T[z()>>2]=e,e}function W(e){try{return g.grow(e-p.byteLength+65535>>>16),b(g.buffer),1}catch(e){}}I(O)||(L=O,O=a.locateFile?a.locateFile(L,l):l+L),B=function(){return performance.now()};var k={};function j(){if(!j.strings){var e={USER:"web_user",LOGNAME:"web_user",PATH:"/",PWD:"/",HOME:"/home/web_user",LANG:("object"==typeof navigator&&navigator.languages&&navigator.languages[0]||"C").replace("-","_")+".UTF-8",_:s||"./this.program"};for(var t in k)e[t]=k[t];var n=[];for(var t in e)n.push(t+"="+e[t]);j.strings=n}return j.strings}var X,H={mappings:{},buffers:[null,[],[]],printChar:function(e,t){var n=H.buffers[e];0===t||10===t?((1===e?d:m)(R(n,0)),n.length=0):n.push(t)},varargs:void 0,get:function(){return H.varargs+=4,T[H.varargs-4>>2]},getStr:function(e){var t=function(e){return e?R(h,e,void 0):""}(e);return t},get64:function(e,t){return e}},q={a:function(){M()},n:function(e,t){var n;if(0===e)n=Date.now();else{if(1!==e&&4!==e)return G(28),-1;n=B()}return T[t>>2]=n/1e3|0,T[t+4>>2]=n%1e3*1e3*1e3|0,0},i:function(e,t){M("To use dlopen, you need to use Emscripten's linking support, see https://github.com/emscripten-core/emscripten/wiki/Linking")},e:function(e,t){M("To use dlopen, you need to use Emscripten's linking support, see https://github.com/emscripten-core/emscripten/wiki/Linking")},l:function(e,t,n){h.copyWithin(e,t,t+n)},m:function(e){var t,n=h.length,r=2147483648;if(e>r)return!1;for(var a=1;a<=4;a*=2){var o=n*(1+.2/a);if(o=Math.min(o,e+100663296),W(Math.min(r,((t=Math.max(e,o))%65536>0&&(t+=65536-t%65536),t))))return!0}return!1},o:function(e){for(var t=B();B()-t<e;);},p:function(e,t){var n=0;return j().forEach((function(r,a){var o=t+n;T[e+4*a>>2]=o,function(e,t){for(var n=0;n<e.length;++n)E[0|t++]=e.charCodeAt(n);E[0|t]=0}(r,o),n+=r.length+1})),0},g:function(e,t){var n=j();T[e>>2]=n.length;var r=0;return n.forEach((function(e){r+=e.length+1})),T[t>>2]=r,0},j:function(e){!function(e){_||(a.onExit&&a.onExit(e),A=!0),c(e,new Y(e))}(e)},h:function(e){return 0},k:function(e,t,n,r,a){},c:function(e,t,n,r){for(var a=0,o=0;o<n;o++){for(var i=T[t+8*o>>2],u=T[t+(8*o+4)>>2],s=0;s<u;s++)H.printChar(e,h[i+s]);a+=u}return T[r>>2]=a,0},d:function(){return 6},f:function(){return 28},b:function(e){switch(e){case 30:case 75:return 16384;case 85:return 131072;case 132:case 133:case 12:case 137:case 138:case 15:case 235:case 16:case 17:case 18:case 19:case 20:case 149:case 13:case 10:case 236:case 153:case 9:case 21:case 22:case 159:case 154:case 14:case 77:case 78:case 139:case 82:case 68:case 67:case 164:case 11:case 29:case 47:case 48:case 95:case 52:case 51:case 46:return 200809;case 27:case 246:case 127:case 128:case 23:case 24:case 160:case 161:case 181:case 182:case 242:case 183:case 184:case 243:case 244:case 245:case 165:case 178:case 179:case 49:case 50:case 168:case 169:case 175:case 170:case 171:case 172:case 97:case 76:case 32:case 173:case 35:case 80:case 81:case 79:return-1;case 176:case 177:case 7:case 155:case 8:case 157:case 125:case 126:case 92:case 93:case 129:case 130:case 131:case 94:case 91:return 1;case 74:case 60:case 69:case 70:case 4:return 1024;case 31:case 42:case 72:return 32;case 87:case 26:case 33:return 2147483647;case 34:case 1:return 47839;case 38:case 36:return 99;case 43:case 37:return 2048;case 0:return 2097152;case 3:return 65536;case 28:return 32768;case 44:return 32767;case 39:return 1e3;case 89:return 700;case 71:return 256;case 40:return 255;case 2:return 100;case 180:return 64;case 25:return 20;case 5:return 16;case 6:return 6;case 73:return 4;case 84:return"object"==typeof navigator&&navigator.hardwareConcurrency||1}return G(28),-1}},V=(function(){var e={a:q};function t(e,t){var n=e.exports;a.asm=n,b((g=a.asm.q).buffer),S=a.asm.D,function(){if(y--,a.monitorRunDependencies&&a.monitorRunDependencies(y),0==y&&(null!==w&&(clearInterval(w),w=null),U)){var e=U;U=null,e()}}()}function n(e){t(e.instance)}function o(t){return(f||"function"!=typeof fetch?Promise.resolve().then((function(){return N(O)})):fetch(O,{credentials:"same-origin"}).then((function(e){if(!e.ok)throw"failed to load wasm binary file at '"+O+"'";return e.arrayBuffer()})).catch((function(){return N(O)}))).then((function(t){return WebAssembly.instantiate(t,e)})).then(t,(function(e){m("failed to asynchronously prepare wasm: "+e),M(e)}))}if(y++,a.monitorRunDependencies&&a.monitorRunDependencies(y),a.instantiateWasm)try{return a.instantiateWasm(e,t)}catch(e){return m("Module.instantiateWasm callback failed with error: "+e),!1}(f||"function"!=typeof WebAssembly.instantiateStreaming||I(O)||"function"!=typeof fetch?o(n):fetch(O,{credentials:"same-origin"}).then((function(t){return WebAssembly.instantiateStreaming(t,e).then(n,(function(e){return m("wasm streaming compile failed: "+e),m("falling back to ArrayBuffer instantiation"),o(n)}))}))).catch(r)}(),a.___wasm_call_ctors=function(){return(V=a.___wasm_call_ctors=a.asm.r).apply(null,arguments)}),z=(a._getModelBufferMemoryOffset=function(){return(a._getModelBufferMemoryOffset=a.asm.s).apply(null,arguments)},a._getInputMemoryOffset=function(){return(a._getInputMemoryOffset=a.asm.t).apply(null,arguments)},a._getInputHeight=function(){return(a._getInputHeight=a.asm.u).apply(null,arguments)},a._getInputWidth=function(){return(a._getInputWidth=a.asm.v).apply(null,arguments)},a._getInputChannelCount=function(){return(a._getInputChannelCount=a.asm.w).apply(null,arguments)},a._getOutputMemoryOffset=function(){return(a._getOutputMemoryOffset=a.asm.x).apply(null,arguments)},a._getOutputHeight=function(){return(a._getOutputHeight=a.asm.y).apply(null,arguments)},a._getOutputWidth=function(){return(a._getOutputWidth=a.asm.z).apply(null,arguments)},a._getOutputChannelCount=function(){return(a._getOutputChannelCount=a.asm.A).apply(null,arguments)},a._loadModel=function(){return(a._loadModel=a.asm.B).apply(null,arguments)},a._runInference=function(){return(a._runInference=a.asm.C).apply(null,arguments)},a.___errno_location=function(){return(z=a.___errno_location=a.asm.E).apply(null,arguments)});function Y(e){this.name="ExitStatus",this.message="Program terminated with exit("+e+")",this.status=e}function J(e){function n(){X||(X=!0,a.calledRun=!0,A||(D(F),D(P),t(a),a.onRuntimeInitialized&&a.onRuntimeInitialized(),function(){if(a.postRun)for("function"==typeof a.postRun&&(a.postRun=[a.postRun]);a.postRun.length;)e=a.postRun.shift(),x.unshift(e);var e;D(x)}()))}e=e||u,y>0||(function(){if(a.preRun)for("function"==typeof a.preRun&&(a.preRun=[a.preRun]);a.preRun.length;)e=a.preRun.shift(),C.unshift(e);var e;D(C)}(),y>0||(a.setStatus?(a.setStatus("Running..."),setTimeout((function(){setTimeout((function(){a.setStatus("")}),1),n()}),1)):n()))}if(U=function e(){X||J(),X||(U=e)},a.run=J,a.preInit)for("function"==typeof a.preInit&&(a.preInit=[a.preInit]);a.preInit.length>0;)a.preInit.pop()();return J(),e.ready});"object"==typeof e&&"object"==typeof t?t.exports=r:"function"==typeof define&&define.amd?define([],(function(){return r})):"object"==typeof e&&(e.createTFLiteModule=r)}}),require_tflite_simd=__commonJS({"src/tflite/tflite-simd.js"(e,t){"use strict";var n,r=(n="undefined"!=typeof document&&document.currentScript?document.currentScript.src:void 0,function(e){var t,r,a=void 0!==(e=e||{})?e:{};a.ready=new Promise((function(e,n){t=e,r=n}));var o,i={};for(o in a)a.hasOwnProperty(o)&&(i[o]=a[o]);var u=[],s="./this.program",c=function(e,t){throw t},l="";"undefined"!=typeof document&&document.currentScript&&(l=document.currentScript.src),n&&(l=n),l=0!==l.indexOf("blob:")?l.substr(0,l.lastIndexOf("/")+1):"";var f,d=a.print||console.log.bind(console),m=a.printErr||console.warn.bind(console);for(o in i)i.hasOwnProperty(o)&&(a[o]=i[o]);i=null,a.arguments&&(u=a.arguments),a.thisProgram&&(s=a.thisProgram),a.quit&&(c=a.quit),a.wasmBinary&&(f=a.wasmBinary);var g,_=a.noExitRuntime||!0;"object"!=typeof WebAssembly&&M("no native wasm support detected");var p,E,h,T,A=!1,v="undefined"!=typeof TextDecoder?new TextDecoder("utf8"):void 0;function R(e,t,n){for(var r=t+n,a=t;e[a]&&!(a>=r);)++a;if(a-t>16&&e.subarray&&v)return v.decode(e.subarray(t,a));for(var o="";t<a;){var i=e[t++];if(128&i){var u=63&e[t++];if(192!=(224&i)){var s=63&e[t++];if((i=224==(240&i)?(15&i)<<12|u<<6|s:(7&i)<<18|u<<12|s<<6|63&e[t++])<65536)o+=String.fromCharCode(i);else{var c=i-65536;o+=String.fromCharCode(55296|c>>10,56320|1023&c)}}else o+=String.fromCharCode((31&i)<<6|u)}else o+=String.fromCharCode(i)}return o}function b(e){p=e,a.HEAP8=E=new Int8Array(e),a.HEAP16=new Int16Array(e),a.HEAP32=T=new Int32Array(e),a.HEAPU8=h=new Uint8Array(e),a.HEAPU16=new Uint16Array(e),a.HEAPU32=new Uint32Array(e),a.HEAPF32=new Float32Array(e),a.HEAPF64=new Float64Array(e)}a.INITIAL_MEMORY;var S,C=[],F=[],P=[],x=[];F.push({func:function(){V()}});var y=0,w=null,U=null;function M(e){a.onAbort&&a.onAbort(e),m(e+=""),A=!0,e="abort("+e+"). Build with -s ASSERTIONS=1 for more info.";var t=new WebAssembly.RuntimeError(e);throw r(t),t}function I(e){return t=e,n="data:application/octet-stream;base64,",String.prototype.startsWith?t.startsWith(n):0===t.indexOf(n);var t,n}a.preloadedImages={},a.preloadedAudios={};var L,B,O="tflite-simd.wasm";function N(e){try{if(e==O&&f)return new Uint8Array(f);throw"both async and sync fetching of the wasm failed"}catch(e){M(e)}}function D(e){for(;e.length>0;){var t=e.shift();if("function"!=typeof t){var n=t.func;"number"==typeof n?void 0===t.arg?S.get(n)():S.get(n)(t.arg):n(void 0===t.arg?null:t.arg)}else t(a)}}function G(e){return T[z()>>2]=e,e}function W(e){try{return g.grow(e-p.byteLength+65535>>>16),b(g.buffer),1}catch(e){}}I(O)||(L=O,O=a.locateFile?a.locateFile(L,l):l+L),B=function(){return performance.now()};var k={};function j(){if(!j.strings){var e={USER:"web_user",LOGNAME:"web_user",PATH:"/",PWD:"/",HOME:"/home/web_user",LANG:("object"==typeof navigator&&navigator.languages&&navigator.languages[0]||"C").replace("-","_")+".UTF-8",_:s||"./this.program"};for(var t in k)e[t]=k[t];var n=[];for(var t in e)n.push(t+"="+e[t]);j.strings=n}return j.strings}var X,H={mappings:{},buffers:[null,[],[]],printChar:function(e,t){var n=H.buffers[e];0===t||10===t?((1===e?d:m)(R(n,0)),n.length=0):n.push(t)},varargs:void 0,get:function(){return H.varargs+=4,T[H.varargs-4>>2]},getStr:function(e){var t=function(e){return e?R(h,e,void 0):""}(e);return t},get64:function(e,t){return e}},q={a:function(){M()},n:function(e,t){var n;if(0===e)n=Date.now();else{if(1!==e&&4!==e)return G(28),-1;n=B()}return T[t>>2]=n/1e3|0,T[t+4>>2]=n%1e3*1e3*1e3|0,0},i:function(e,t){M("To use dlopen, you need to use Emscripten's linking support, see https://github.com/emscripten-core/emscripten/wiki/Linking")},e:function(e,t){M("To use dlopen, you need to use Emscripten's linking support, see https://github.com/emscripten-core/emscripten/wiki/Linking")},l:function(e,t,n){h.copyWithin(e,t,t+n)},m:function(e){var t,n=h.length,r=2147483648;if(e>r)return!1;for(var a=1;a<=4;a*=2){var o=n*(1+.2/a);if(o=Math.min(o,e+100663296),W(Math.min(r,((t=Math.max(e,o))%65536>0&&(t+=65536-t%65536),t))))return!0}return!1},o:function(e){for(var t=B();B()-t<e;);},p:function(e,t){var n=0;return j().forEach((function(r,a){var o=t+n;T[e+4*a>>2]=o,function(e,t){for(var n=0;n<e.length;++n)E[0|t++]=e.charCodeAt(n);E[0|t]=0}(r,o),n+=r.length+1})),0},g:function(e,t){var n=j();T[e>>2]=n.length;var r=0;return n.forEach((function(e){r+=e.length+1})),T[t>>2]=r,0},j:function(e){!function(e){_||(a.onExit&&a.onExit(e),A=!0),c(e,new Y(e))}(e)},h:function(e){return 0},k:function(e,t,n,r,a){},c:function(e,t,n,r){for(var a=0,o=0;o<n;o++){for(var i=T[t+8*o>>2],u=T[t+(8*o+4)>>2],s=0;s<u;s++)H.printChar(e,h[i+s]);a+=u}return T[r>>2]=a,0},d:function(){return 6},f:function(){return 28},b:function(e){switch(e){case 30:case 75:return 16384;case 85:return 131072;case 132:case 133:case 12:case 137:case 138:case 15:case 235:case 16:case 17:case 18:case 19:case 20:case 149:case 13:case 10:case 236:case 153:case 9:case 21:case 22:case 159:case 154:case 14:case 77:case 78:case 139:case 82:case 68:case 67:case 164:case 11:case 29:case 47:case 48:case 95:case 52:case 51:case 46:return 200809;case 27:case 246:case 127:case 128:case 23:case 24:case 160:case 161:case 181:case 182:case 242:case 183:case 184:case 243:case 244:case 245:case 165:case 178:case 179:case 49:case 50:case 168:case 169:case 175:case 170:case 171:case 172:case 97:case 76:case 32:case 173:case 35:case 80:case 81:case 79:return-1;case 176:case 177:case 7:case 155:case 8:case 157:case 125:case 126:case 92:case 93:case 129:case 130:case 131:case 94:case 91:return 1;case 74:case 60:case 69:case 70:case 4:return 1024;case 31:case 42:case 72:return 32;case 87:case 26:case 33:return 2147483647;case 34:case 1:return 47839;case 38:case 36:return 99;case 43:case 37:return 2048;case 0:return 2097152;case 3:return 65536;case 28:return 32768;case 44:return 32767;case 39:return 1e3;case 89:return 700;case 71:return 256;case 40:return 255;case 2:return 100;case 180:return 64;case 25:return 20;case 5:return 16;case 6:return 6;case 73:return 4;case 84:return"object"==typeof navigator&&navigator.hardwareConcurrency||1}return G(28),-1}},V=(function(){var e={a:q};function t(e,t){var n=e.exports;a.asm=n,b((g=a.asm.q).buffer),S=a.asm.D,function(){if(y--,a.monitorRunDependencies&&a.monitorRunDependencies(y),0==y&&(null!==w&&(clearInterval(w),w=null),U)){var e=U;U=null,e()}}()}function n(e){t(e.instance)}function o(t){return(f||"function"!=typeof fetch?Promise.resolve().then((function(){return N(O)})):fetch(O,{credentials:"same-origin"}).then((function(e){if(!e.ok)throw"failed to load wasm binary file at '"+O+"'";return e.arrayBuffer()})).catch((function(){return N(O)}))).then((function(t){return WebAssembly.instantiate(t,e)})).then(t,(function(e){m("failed to asynchronously prepare wasm: "+e),M(e)}))}if(y++,a.monitorRunDependencies&&a.monitorRunDependencies(y),a.instantiateWasm)try{return a.instantiateWasm(e,t)}catch(e){return m("Module.instantiateWasm callback failed with error: "+e),!1}(f||"function"!=typeof WebAssembly.instantiateStreaming||I(O)||"function"!=typeof fetch?o(n):fetch(O,{credentials:"same-origin"}).then((function(t){return WebAssembly.instantiateStreaming(t,e).then(n,(function(e){return m("wasm streaming compile failed: "+e),m("falling back to ArrayBuffer instantiation"),o(n)}))}))).catch(r)}(),a.___wasm_call_ctors=function(){return(V=a.___wasm_call_ctors=a.asm.r).apply(null,arguments)}),z=(a._getModelBufferMemoryOffset=function(){return(a._getModelBufferMemoryOffset=a.asm.s).apply(null,arguments)},a._getInputMemoryOffset=function(){return(a._getInputMemoryOffset=a.asm.t).apply(null,arguments)},a._getInputHeight=function(){return(a._getInputHeight=a.asm.u).apply(null,arguments)},a._getInputWidth=function(){return(a._getInputWidth=a.asm.v).apply(null,arguments)},a._getInputChannelCount=function(){return(a._getInputChannelCount=a.asm.w).apply(null,arguments)},a._getOutputMemoryOffset=function(){return(a._getOutputMemoryOffset=a.asm.x).apply(null,arguments)},a._getOutputHeight=function(){return(a._getOutputHeight=a.asm.y).apply(null,arguments)},a._getOutputWidth=function(){return(a._getOutputWidth=a.asm.z).apply(null,arguments)},a._getOutputChannelCount=function(){return(a._getOutputChannelCount=a.asm.A).apply(null,arguments)},a._loadModel=function(){return(a._loadModel=a.asm.B).apply(null,arguments)},a._runInference=function(){return(a._runInference=a.asm.C).apply(null,arguments)},a.___errno_location=function(){return(z=a.___errno_location=a.asm.E).apply(null,arguments)});function Y(e){this.name="ExitStatus",this.message="Program terminated with exit("+e+")",this.status=e}function J(e){function n(){X||(X=!0,a.calledRun=!0,A||(D(F),D(P),t(a),a.onRuntimeInitialized&&a.onRuntimeInitialized(),function(){if(a.postRun)for("function"==typeof a.postRun&&(a.postRun=[a.postRun]);a.postRun.length;)e=a.postRun.shift(),x.unshift(e);var e;D(x)}()))}e=e||u,y>0||(function(){if(a.preRun)for("function"==typeof a.preRun&&(a.preRun=[a.preRun]);a.preRun.length;)e=a.preRun.shift(),C.unshift(e);var e;D(C)}(),y>0||(a.setStatus?(a.setStatus("Running..."),setTimeout((function(){setTimeout((function(){a.setStatus("")}),1),n()}),1)):n()))}if(U=function e(){X||J(),X||(U=e)},a.run=J,a.preInit)for("function"==typeof a.preInit&&(a.preInit=[a.preInit]);a.preInit.length>0;)a.preInit.pop()();return J(),e.ready});"object"==typeof e&&"object"==typeof t?t.exports=r:"function"==typeof define&&define.amd?define([],(function(){return r})):"object"==typeof e&&(e.createTFLiteSIMDModule=r)}}),createPixelGif=(()=>{const e="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=";return function(e){return"data:image/gif;base64,R0lGODlhAQABAPAA"+function(e){let n=e.substring(1,7);n.length<6&&(n=n[0]+n[0]+n[1]+n[1]+n[2]+n[2]);const r=[parseInt(n[0]+n[1],16),parseInt(n[2]+n[3],16),parseInt(n[4]+n[5],16)];return a=r[2],t(0,r[0],r[1])+t(a,255,255);var a}(e)+"/yH5BAAAAAAALAAAAAABAAEAAAICRAEAOw=="};function t(t,n,r){const a=(3&t)<<4|n>>4,o=(15&n)<<2|r>>6,i=63&r;return e.charAt(t>>2)+e.charAt(a)+e.charAt(o)+e.charAt(i)}})();function toBackgroundConfig(e,t){if(!e||"none"===e.type)return{type:"none"};const n=(null==t?void 0:t.bgUrl)||(null==e?void 0:e.url);if("image"===e.type&&n)return{type:"image",url:n};const r=(null==t?void 0:t.bgColor)||(null==e?void 0:e.color);return"color"===e.type&&r?{type:"image",url:createPixelGif(r)}:"blur"===e.type?{type:"blur"}:{type:"none"}}var BRIGHTNESS_ADJUSTMENT_VARIANCE=5,LOW_LIGHT_TIMEOUT_MS=500,BRIGHTNESS_TO_CONTRAST_RATIO=2,PIXEL_SAMPLING_INCREMENT=200;function calculateBrightnessPercentage(e){const t=e.length,n={r:0,g:0,b:0};for(let r=0;r<t-2;r+=PIXEL_SAMPLING_INCREMENT)n.r+=e[r],n.g+=e[r+1],n.b+=e[r+2];return n.r=~~(n.r/(t/PIXEL_SAMPLING_INCREMENT)),n.g=~~(n.g/(t/PIXEL_SAMPLING_INCREMENT)),n.b=~~(n.b/(t/PIXEL_SAMPLING_INCREMENT)),Math.round((.2126*n.r+.7152*n.g+.0722*n.b)/255*100*100)/100}function getCurrentBrightnessAdjustment(e,t){for(let n=0;n<t.length;n++){const r=t[n];if(r.threshold>=e)return r}return t[t.length-1]}function shouldUpdateBrightnessAdjustmentRelativeToLastUpdate(e,t){return e<t-BRIGHTNESS_ADJUSTMENT_VARIANCE||e>t+BRIGHTNESS_ADJUSTMENT_VARIANCE}var import_tflite=__toESM(require_tflite()),import_tflite_simd=__toESM(require_tflite_simd()),DEFAULT_SEGMENTATION_CONFIG={model:"meet-160x96",backend:"wasmSimd",pipeline:"webgl2",wasmFilePrefix:"https://cdn.loom.com/tflite/v2/"},INPUT_RESOLUTION_PER_MODEL={"meet-160x96":[160,96],"meet-256x144":[256,144],mlkit:[256,256]},buildSegmentationConfig=e=>__spreadValues(__spreadValues({},DEFAULT_SEGMENTATION_CONFIG),e);function getTFLiteModelFileName(e){switch(e){case"meet-256x144":return"segm_full_v679";case"meet-160x96":return"segm_lite_v681";case"mlkit":return"selfiesegmentation_mlkit-256x256-2021_01_19-v1215.f16";default:throw new Error("No TFLite file for this segmentation model: ".concat(e))}}var buildTflite=async e=>{const t={locateFile:t=>"".concat(e.wasmFilePrefix).concat(t).replace(/([a-z0-9])(\/+)/gi,"$1/")};if("wasmSimd"===e.backend)try{return{tflite:await(0,import_tflite_simd.default)(t),simd:!0}}catch(e){console.warn("Failed to create TFLite SIMD WebAssembly module.",e)}return{tflite:await(0,import_tflite.default)(t),simd:!1}},buildSegmenter=async e=>{const t=(await buildTflite(e)).tflite;return await loadModel(t,e),{write:e=>{const n=t._getInputMemoryOffset()/4,r=new Uint8Array(e);for(let e=0;e<r.byteLength/4;e++){const a=n+3*e,o=4*e;t.HEAPF32[a]=r[o]/255,t.HEAPF32[a+1]=r[o+1]/255,t.HEAPF32[a+2]=r[o+2]/255}},read:()=>{const e=t._getOutputMemoryOffset()/4*Float32Array.BYTES_PER_ELEMENT;return new Float32Array(t.HEAPF32.buffer,e)},run(){t._runInference()}}},loadModel=async(e,t)=>{console.log("loading model");const n=getTFLiteModelFileName(t.model);console.log("Loading tflite model:",n);const r=await fetch("https://cdn.loom.com/tflite/".concat(n,".tflite")),a=await r.arrayBuffer();console.log("Model buffer size:",a.byteLength);const o=e._getModelBufferMemoryOffset();e.HEAPU8.set(new Uint8Array(a),o),e._loadModel(a.byteLength)},glsl=String.raw;function createPipelineStageProgram(e,t,n,r,a){const o=createProgram(e,t,n),i=e.getAttribLocation(o,"a_position");e.enableVertexAttribArray(i),e.bindBuffer(e.ARRAY_BUFFER,r),e.vertexAttribPointer(i,2,e.FLOAT,!1,0,0);const u=e.getAttribLocation(o,"a_texCoord");return e.enableVertexAttribArray(u),e.bindBuffer(e.ARRAY_BUFFER,a),e.vertexAttribPointer(u,2,e.FLOAT,!1,0,0),o}function createProgram(e,t,n){const r=e.createProgram();if(e.attachShader(r,t),e.attachShader(r,n),e.linkProgram(r),!e.getProgramParameter(r,e.LINK_STATUS))throw new Error("Could not link WebGL program: ".concat(e.getProgramInfoLog(r)));return r}function compileShader(e,t,n){const r=e.createShader(t);if(e.shaderSource(r,n),e.compileShader(r),!e.getShaderParameter(r,e.COMPILE_STATUS))throw new Error("Could not compile shader: ".concat(e.getShaderInfoLog(r)));return r}function getAssignedLocationForPreviousResult(e,t){e.uniform1i(t,8)}function allocateUnitForPreviousTexture(e,t){e.activeTexture(e.TEXTURE8),e.bindTexture(e.TEXTURE_2D,t)}function createTexture(e,t,n,r,a=e.NEAREST,o=e.NEAREST){const i=e.createTexture();return e.bindTexture(e.TEXTURE_2D,i),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_S,e.CLAMP_TO_EDGE),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_T,e.CLAMP_TO_EDGE),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MIN_FILTER,a),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MAG_FILTER,o),e.texStorage2D(e.TEXTURE_2D,1,t,n,r),i}async function readPixelsAsync(e,t,n,r,a,o,i,u){const s=e.createBuffer();return e.bindBuffer(e.PIXEL_PACK_BUFFER,s),e.bufferData(e.PIXEL_PACK_BUFFER,u.byteLength,e.STREAM_READ),e.readPixels(t,n,r,a,o,i,0),e.bindBuffer(e.PIXEL_PACK_BUFFER,null),await getBufferSubDataAsync(e,e.PIXEL_PACK_BUFFER,s,0,u),e.deleteBuffer(s),u}async function getBufferSubDataAsync(e,t,n,r,a,o,i){const u=e.fenceSync(e.SYNC_GPU_COMMANDS_COMPLETE,0);e.flush();const s=await clientWaitAsync(e,u);e.deleteSync(u),s!==e.WAIT_FAILED&&(e.bindBuffer(t,n),e.getBufferSubData(t,r,a,o,i),e.bindBuffer(t,null))}function clientWaitAsync(e,t){return new Promise((n=>{setTimeout((function r(){const a=e.clientWaitSync(t,0,0);a!==e.WAIT_FAILED?a!==e.TIMEOUT_EXPIRED?n(a):setTimeout(r,0):n(a)}),0)}))}var _a,_b,_c,_a2,_b2,_a3,_a4,_a5,_a6,_a7,WEBGL_SEGMENTATION_STAGE_NAME="segmentation",WEBGL_SEGMENTATION_TFLITE_STAGE_NAME="tflite_inference",WEBGL_BLEMISH_SMOOTHING_STAGE_NAME="blemish_smoothing",WEBGL_LOW_LIGHT_STAGE_NAME="low_light",WEBGL_CONTRAST_STAGE_NAME="contrast",WEBGL_RENDER_BACKGROUND_TO_TEXTURE_STAGE_NAME="background_to_texture",WEBGL_WRITE_TO_CANVAS_STAGE_NAME="write_to_canvas",WEBGL_SOFTMAX_STAGE_NAME="softmax",WEBGL_BLUR_STAGE_NAME="background_blur",WEBGL_BCG_IMAGE_STAGE_NAME="background_image",WEBGL_STAGE_COMPLETE="webgl_stage_complete";function buildBackgroundBlurStage(e,t,n,r,a,o){const i=buildBlurPass(e,t,n,r,a,o),u=buildBlendPass(e,n,r,o);return{render:function(){return i.render(),u.render(),null},renderToTexture:function(){return i.renderFromPreviousStage(),u.renderToTexture()},updateCoverage:function(e){u.updateCoverage(e)},cleanUp:function(){u.cleanUp(),i.cleanUp()},getStageName:function(){return WEBGL_BLUR_STAGE_NAME}}}function buildBlurPass(e,t,n,r,a,o){const i=glsl(_a||(_a=__template(["#version 300 es\n\n    precision highp float;\n\n    uniform sampler2D u_inputFrame;\n    uniform sampler2D u_personMask;\n    uniform vec2 u_texelSize;\n\n    in vec2 v_texCoord;\n\n    out vec4 outColor;\n\n    const float offset[5] = float[](0.0, 1.0, 2.0, 3.0, 4.0);\n    const float weight[5] = float[](0.2270270270, 0.1945945946, 0.1216216216,\n      0.0540540541, 0.0162162162);\n\n    void main() {\n      vec4 centerColor = texture(u_inputFrame, v_texCoord);\n      float personMask = texture(u_personMask, v_texCoord).a;\n\n      vec4 frameColor = centerColor * weight[0] * (1.0 - personMask);\n\n      for (int i = 1; i < 5; i++) {\n        vec2 offset = vec2(offset[i]) * u_texelSize;\n\n        vec2 texCoord = v_texCoord + offset;\n        frameColor += texture(u_inputFrame, texCoord) * weight[i] *\n          (1.0 - texture(u_personMask, texCoord).a);\n\n        texCoord = v_texCoord - offset;\n        frameColor += texture(u_inputFrame, texCoord) * weight[i] *\n          (1.0 - texture(u_personMask, texCoord).a);\n      }\n      outColor = vec4(frameColor.rgb + (1.0 - frameColor.a) * centerColor.rgb, 1.0);\n    }\n  "]))),u=.5*o.width,s=.5*o.height,c=1/u,l=1/s,f=compileShader(e,e.FRAGMENT_SHADER,i),d=createPipelineStageProgram(e,t,f,n,r),m=e.getUniformLocation(d,"u_inputFrame"),g=e.getUniformLocation(d,"u_personMask"),_=e.getUniformLocation(d,"u_texelSize"),p=createTexture(e,e.RGBA8,u,s,e.NEAREST,e.LINEAR),E=createTexture(e,e.RGBA8,u,s,e.NEAREST,e.LINEAR),h=e.createFramebuffer();e.bindFramebuffer(e.FRAMEBUFFER,h),e.framebufferTexture2D(e.FRAMEBUFFER,e.COLOR_ATTACHMENT0,e.TEXTURE_2D,p,0);const T=e.createFramebuffer();function A(){e.activeTexture(e.TEXTURE1),e.bindTexture(e.TEXTURE_2D,a);for(let t=0;t<3;t++)e.uniform2f(_,0,l),e.bindFramebuffer(e.FRAMEBUFFER,h),e.drawArrays(e.TRIANGLE_STRIP,0,4),e.activeTexture(e.TEXTURE2),e.bindTexture(e.TEXTURE_2D,p),e.uniform1i(m,2),e.uniform2f(_,c,0),e.bindFramebuffer(e.FRAMEBUFFER,T),e.drawArrays(e.TRIANGLE_STRIP,0,4),e.bindTexture(e.TEXTURE_2D,E)}return e.bindFramebuffer(e.FRAMEBUFFER,T),e.framebufferTexture2D(e.FRAMEBUFFER,e.COLOR_ATTACHMENT0,e.TEXTURE_2D,E,0),e.useProgram(d),e.uniform1i(g,1),{render:function(){return e.viewport(0,0,u,s),e.useProgram(d),e.uniform1i(m,0),A(),null},renderFromPreviousStage:function(){e.viewport(0,0,u,s),e.useProgram(d),getAssignedLocationForPreviousResult(e,m),A()},cleanUp:function(){e.deleteFramebuffer(T),e.deleteFramebuffer(h),e.deleteTexture(E),e.deleteTexture(p),e.deleteProgram(d),e.deleteShader(f)}}}function buildBlendPass(e,t,n,r){const a=glsl(_b||(_b=__template(["#version 300 es\n\n    in vec2 a_position;\n    in vec2 a_texCoord;\n\n    out vec2 v_texCoord;\n\n    void main() {\n      // Flipping Y is required when rendering to canvas\n      gl_Position = vec4(a_position * vec2(1.0, -1.0), 0.0, 1.0);\n      v_texCoord = a_texCoord;\n    }\n  "]))),o=glsl(_c||(_c=__template(["#version 300 es\n\n    precision highp float;\n\n    uniform sampler2D u_inputFrame;\n    uniform sampler2D u_personMask;\n    uniform sampler2D u_blurredInputFrame;\n    uniform vec2 u_coverage;\n\n    in vec2 v_texCoord;\n\n    out vec4 outColor;\n\n    void main() {\n      vec3 color = texture(u_inputFrame, v_texCoord).rgb;\n      vec3 blurredColor = texture(u_blurredInputFrame, v_texCoord).rgb;\n      float personMask = texture(u_personMask, v_texCoord).a;\n      personMask = smoothstep(u_coverage.x, u_coverage.y, personMask);\n      outColor = vec4(mix(blurredColor, color, personMask), 1.0);\n    }\n  "]))),{width:i,height:u}=r,s=compileShader(e,e.VERTEX_SHADER,a),c=compileShader(e,e.FRAGMENT_SHADER,o),l=createPipelineStageProgram(e,s,c,t,n),f=e.getUniformLocation(l,"u_inputFrame"),d=e.getUniformLocation(l,"u_personMask"),m=e.getUniformLocation(l,"u_blurredInputFrame"),g=e.getUniformLocation(l,"u_coverage");e.useProgram(l),e.uniform1i(f,0),e.uniform1i(d,1),e.uniform1i(m,2),e.uniform2f(g,0,1);const _=e.createFramebuffer(),p=createTexture(e,e.RGBA8,i,u);return e.bindFramebuffer(e.FRAMEBUFFER,_),e.framebufferTexture2D(e.FRAMEBUFFER,e.COLOR_ATTACHMENT0,e.TEXTURE_2D,p,0),{render:function(){return e.viewport(0,0,i,u),e.useProgram(l),e.bindFramebuffer(e.FRAMEBUFFER,null),e.drawArrays(e.TRIANGLE_STRIP,0,4),null},renderToTexture:function(){return e.viewport(0,0,i,u),e.useProgram(l),e.activeTexture(e.TEXTURE8),getAssignedLocationForPreviousResult(e,f),e.bindFramebuffer(e.FRAMEBUFFER,_),e.drawArrays(e.TRIANGLE_STRIP,0,4),p},updateCoverage:function(t){e.useProgram(l),e.uniform2f(g,t[0],t[1])},cleanUp:function(){e.deleteTexture(p),e.deleteProgram(l),e.deleteFramebuffer(_),e.deleteShader(c),e.deleteShader(s)}}}async function loadImage(e){return createImageBitmap(await(await fetch(e)).blob())}function buildBackgroundImageStage(e,t,n,r,a,o){const i=glsl(_a2||(_a2=__template(["#version 300 es\n\n    uniform vec2 u_backgroundScale;\n    uniform vec2 u_backgroundOffset;\n\n    in vec2 a_position;\n    in vec2 a_texCoord;\n\n    out vec2 v_texCoord;\n    out vec2 v_backgroundCoord;\n\n    void main() {\n      // Flipping Y is required when rendering to canvas\n      gl_Position = vec4(a_position * vec2(1.0, -1.0), 0.0, 1.0);\n      v_texCoord = a_texCoord;\n      v_backgroundCoord = a_texCoord * u_backgroundScale + u_backgroundOffset;\n    }\n  "]))),u=glsl(_b2||(_b2=__template(["#version 300 es\n\n    precision highp float;\n\n    uniform sampler2D u_inputFrame;\n    uniform sampler2D u_personMask;\n    uniform sampler2D u_background;\n    uniform vec2 u_coverage;\n    uniform float u_lightWrapping;\n    uniform float u_blendMode;\n\n    in vec2 v_texCoord;\n    in vec2 v_backgroundCoord;\n\n    out vec4 outColor;\n\n    vec3 screen(vec3 a, vec3 b) {\n      return 1.0 - (1.0 - a) * (1.0 - b);\n    }\n\n    vec3 linearDodge(vec3 a, vec3 b) {\n      return a + b;\n    }\n\n    void main() {\n      vec3 frameColor = texture(u_inputFrame, v_texCoord).rgb;\n      vec3 backgroundColor = texture(u_background, v_backgroundCoord).rgb;\n      float personMask = texture(u_personMask, v_texCoord).a;\n      float lightWrapMask = 1.0 - max(0.0, personMask - u_coverage.y) / (1.0 - u_coverage.y);\n      vec3 lightWrap = u_lightWrapping * lightWrapMask * backgroundColor;\n      frameColor = u_blendMode * linearDodge(frameColor, lightWrap) +\n        (1.0 - u_blendMode) * screen(frameColor, lightWrap);\n      personMask = smoothstep(u_coverage.x, u_coverage.y, personMask);\n      outColor = vec4(frameColor * personMask + backgroundColor * (1.0 - personMask), 1.0);\n    }\n  "]))),{width:s,height:c}=o,l=s/c,f=compileShader(e,e.VERTEX_SHADER,i),d=compileShader(e,e.FRAGMENT_SHADER,u),m=createPipelineStageProgram(e,f,d,t,n),g=e.getUniformLocation(m,"u_backgroundScale"),_=e.getUniformLocation(m,"u_backgroundOffset"),p=e.getUniformLocation(m,"u_inputFrame"),E=e.getUniformLocation(m,"u_personMask"),h=e.getUniformLocation(m,"u_background"),T=e.getUniformLocation(m,"u_coverage"),A=e.getUniformLocation(m,"u_lightWrapping"),v=e.getUniformLocation(m,"u_blendMode");e.useProgram(m),e.uniform2f(g,1,1),e.uniform2f(_,0,0),e.uniform1i(E,1),e.uniform2f(T,0,1),e.uniform1f(A,0),e.uniform1f(v,0);let R=null;a&&loadImage(a).then((t=>{!function(t){R=createTexture(e,e.RGBA8,t.width,t.height,e.LINEAR,e.LINEAR),e.texSubImage2D(e.TEXTURE_2D,0,0,0,t.width,t.height,e.RGBA,e.UNSIGNED_BYTE,t);let n=0,r=0,a=t.width,o=t.height;a/o<l?(o=a/l,r=(t.height-o)/2):(a=o*l,n=(t.width-a)/2);const i=a/t.width,u=o/t.height;n/=t.width,r/=t.height,e.uniform2f(g,i,u),e.uniform2f(_,n,r)}(t)}));const b=e.createFramebuffer(),S=createTexture(e,e.RGBA8,s,c);return e.bindFramebuffer(e.FRAMEBUFFER,b),e.framebufferTexture2D(e.FRAMEBUFFER,e.COLOR_ATTACHMENT0,e.TEXTURE_2D,S,0),{render:function(){return e.viewport(0,0,s,c),e.useProgram(m),e.activeTexture(e.TEXTURE0),e.uniform1i(p,0),e.activeTexture(e.TEXTURE1),e.bindTexture(e.TEXTURE_2D,r),null!==R&&(e.activeTexture(e.TEXTURE2),e.bindTexture(e.TEXTURE_2D,R),e.uniform1i(h,2)),e.bindFramebuffer(e.FRAMEBUFFER,null),e.drawArrays(e.TRIANGLE_STRIP,0,4),null},renderToTexture:function(){return e.viewport(0,0,s,c),e.useProgram(m),e.activeTexture(e.TEXTURE1),e.bindTexture(e.TEXTURE_2D,r),e.activeTexture(e.TEXTURE8),getAssignedLocationForPreviousResult(e,p),null!==R?(e.activeTexture(e.TEXTURE2),e.bindTexture(e.TEXTURE_2D,R),e.uniform1i(h,2)):getAssignedLocationForPreviousResult(e,h),e.bindFramebuffer(e.FRAMEBUFFER,b),e.drawArrays(e.TRIANGLE_STRIP,0,4),S},updateCoverage:function(t){e.useProgram(m),e.uniform2f(T,t[0],t[1])},updateLightWrapping:function(t){e.useProgram(m),e.uniform1f(A,t)},updateBlendMode:function(t){e.useProgram(m),e.uniform1f(v,"screen"===t?0:1)},cleanUp:function(){e.deleteFramebuffer(b),e.deleteTexture(S),e.deleteTexture(R),e.deleteProgram(m),e.deleteShader(d),e.deleteShader(f)},getStageName:function(){return WEBGL_BCG_IMAGE_STAGE_NAME}}}function buildJointBilateralFilterStage(e,t,n,r,a,o,i,u){const s=glsl(_a3||(_a3=__template(["#version 300 es\n\n    precision highp float;\n\n    uniform sampler2D u_inputFrame;\n    uniform sampler2D u_segmentationMask;\n    uniform vec2 u_texelSize;\n    uniform float u_step;\n    uniform float u_radius;\n    uniform float u_offset;\n    uniform float u_sigmaTexel;\n    uniform float u_sigmaColor;\n\n    in vec2 v_texCoord;\n\n    out vec4 outColor;\n\n    float gaussian(float x, float sigma) {\n      float coeff = -0.5 / (sigma * sigma * 4.0 + 1.0e-6);\n      return exp((x * x) * coeff);\n    }\n\n    void main() {\n      vec2 centerCoord = v_texCoord;\n      vec3 centerColor = texture(u_inputFrame, centerCoord).rgb;\n      float newVal = 0.0;\n\n      float spaceWeight = 0.0;\n      float colorWeight = 0.0;\n      float totalWeight = 0.0;\n\n      // Subsample kernel space.\n      for (float i = -u_radius + u_offset; i <= u_radius; i += u_step) {\n        for (float j = -u_radius + u_offset; j <= u_radius; j += u_step) {\n          vec2 shift = vec2(j, i) * u_texelSize;\n          vec2 coord = vec2(centerCoord + shift);\n          vec3 frameColor = texture(u_inputFrame, coord).rgb;\n          float outVal = texture(u_segmentationMask, coord).a;\n\n          spaceWeight = gaussian(distance(centerCoord, coord), u_sigmaTexel);\n          colorWeight = gaussian(distance(centerColor, frameColor), u_sigmaColor);\n          totalWeight += spaceWeight * colorWeight;\n\n          newVal += spaceWeight * colorWeight * outVal;\n        }\n      }\n      newVal /= totalWeight;\n\n      outColor = vec4(vec3(0.0), newVal);\n    }\n  "]))),[c,l]=INPUT_RESOLUTION_PER_MODEL[o.model],{width:f,height:d}=u,m=1/f,g=1/d,_=compileShader(e,e.FRAGMENT_SHADER,s),p=createPipelineStageProgram(e,t,_,n,r),E=e.getUniformLocation(p,"u_inputFrame"),h=e.getUniformLocation(p,"u_segmentationMask"),T=e.getUniformLocation(p,"u_texelSize"),A=e.getUniformLocation(p,"u_step"),v=e.getUniformLocation(p,"u_radius"),R=e.getUniformLocation(p,"u_offset"),b=e.getUniformLocation(p,"u_sigmaTexel"),S=e.getUniformLocation(p,"u_sigmaColor"),C=e.createFramebuffer();function F(t){t*=Math.max(f/c,d/l);const n=Math.max(1,.66*Math.sqrt(t)),r=t,a=n>1?.5*n:0,o=Math.max(m,g)*t;e.useProgram(p),e.uniform1f(A,n),e.uniform1f(v,r),e.uniform1f(R,a),e.uniform1f(b,o)}function P(t){e.useProgram(p),e.uniform1f(S,t)}return e.bindFramebuffer(e.FRAMEBUFFER,C),e.framebufferTexture2D(e.FRAMEBUFFER,e.COLOR_ATTACHMENT0,e.TEXTURE_2D,i,0),e.useProgram(p),e.uniform1i(E,0),e.uniform1i(h,1),e.uniform2f(T,m,g),F(0),P(0),{render:function(){e.viewport(0,0,f,d),e.useProgram(p),e.activeTexture(e.TEXTURE1),e.bindTexture(e.TEXTURE_2D,a),e.bindFramebuffer(e.FRAMEBUFFER,C),e.drawArrays(e.TRIANGLE_STRIP,0,4)},updateSigmaSpace:F,updateSigmaColor:P,cleanUp:function(){e.deleteFramebuffer(C),e.deleteProgram(p),e.deleteShader(_)}}}function buildLoadSegmentationStage(e,t,n,r,a,o,i){const u=glsl(_a4||(_a4=__template(["#version 300 es\n\n    precision highp float;\n\n    uniform sampler2D u_inputSegmentation;\n\n    in vec2 v_texCoord;\n\n    out vec4 outColor;\n\n    void main() {\n      float segmentation = texture(u_inputSegmentation, v_texCoord).r;\n      outColor = vec4(vec3(0.0), segmentation);\n    }\n  "]))),[s,c]=INPUT_RESOLUTION_PER_MODEL[a.model],l=compileShader(e,e.FRAGMENT_SHADER,u),f=createPipelineStageProgram(e,t,l,n,r),d=e.getUniformLocation(f,"u_inputSegmentation"),m=createTexture(e,e.R32F,s,c),g=e.createFramebuffer();return e.bindFramebuffer(e.FRAMEBUFFER,g),e.framebufferTexture2D(e.FRAMEBUFFER,e.COLOR_ATTACHMENT0,e.TEXTURE_2D,i,0),e.useProgram(f),e.uniform1i(d,1),{render:function(){return e.viewport(0,0,s,c),e.useProgram(f),e.activeTexture(e.TEXTURE1),e.bindTexture(e.TEXTURE_2D,m),e.texSubImage2D(e.TEXTURE_2D,0,0,0,s,c,e.RED,e.FLOAT,o.read()),e.bindFramebuffer(e.FRAMEBUFFER,g),e.drawArrays(e.TRIANGLE_STRIP,0,4),null},cleanUp:function(){e.deleteFramebuffer(g),e.deleteTexture(m),e.deleteProgram(f),e.deleteShader(l)},getStageName:function(){return WEBGL_SEGMENTATION_STAGE_NAME}}}function buildResizingStage(e,t,n,r,a,o){const i=glsl(_a5||(_a5=__template(["#version 300 es\n\n    precision highp float;\n\n    uniform sampler2D u_inputFrame;\n\n    in vec2 v_texCoord;\n\n    out vec4 outColor;\n\n    void main() {\n      outColor = texture(u_inputFrame, v_texCoord);\n    }\n  "]))),[u,s]=INPUT_RESOLUTION_PER_MODEL[a.model],c=u*s,l=compileShader(e,e.FRAGMENT_SHADER,i),f=createPipelineStageProgram(e,t,l,n,r),d=e.getUniformLocation(f,"u_inputFrame"),m=createTexture(e,e.RGBA8,u,s),g=e.createFramebuffer();e.bindFramebuffer(e.FRAMEBUFFER,g),e.framebufferTexture2D(e.FRAMEBUFFER,e.COLOR_ATTACHMENT0,e.TEXTURE_2D,m,0);const _=new Uint8Array(4*c);return e.useProgram(f),e.uniform1i(d,0),{render:async function(){e.viewport(0,0,u,s),e.useProgram(f),e.bindFramebuffer(e.FRAMEBUFFER,g),e.drawArrays(e.TRIANGLE_STRIP,0,4),await readPixelsAsync(e,0,0,u,s,e.RGBA,e.UNSIGNED_BYTE,_),o.write(_)},cleanUp:function(){e.deleteFramebuffer(g),e.deleteTexture(m),e.deleteProgram(f),e.deleteShader(l)}}}function buildSoftmaxStage(e,t,n,r,a,o,i){const u=glsl(_a6||(_a6=__template(["#version 300 es\n\n    precision highp float;\n\n    uniform sampler2D u_inputSegmentation;\n\n    in vec2 v_texCoord;\n\n    out vec4 outColor;\n\n    void main() {\n      vec2 segmentation = texture(u_inputSegmentation, v_texCoord).rg;\n      float shift = max(segmentation.r, segmentation.g);\n      float backgroundExp = exp(segmentation.r - shift);\n      float personExp = exp(segmentation.g - shift);\n      outColor = vec4(vec3(0.0), personExp / (backgroundExp + personExp));\n    }\n  "]))),[s,c]=INPUT_RESOLUTION_PER_MODEL[a.model],l=compileShader(e,e.FRAGMENT_SHADER,u),f=createPipelineStageProgram(e,t,l,n,r),d=e.getUniformLocation(f,"u_inputSegmentation"),m=createTexture(e,e.RG32F,s,c),g=e.createFramebuffer();return e.bindFramebuffer(e.FRAMEBUFFER,g),e.framebufferTexture2D(e.FRAMEBUFFER,e.COLOR_ATTACHMENT0,e.TEXTURE_2D,i,0),e.useProgram(f),e.uniform1i(d,1),{render:function(){return e.viewport(0,0,s,c),e.useProgram(f),e.activeTexture(e.TEXTURE1),e.bindTexture(e.TEXTURE_2D,m),e.texSubImage2D(e.TEXTURE_2D,0,0,0,s,c,e.RG,e.FLOAT,o.read()),e.bindFramebuffer(e.FRAMEBUFFER,g),e.drawArrays(e.TRIANGLE_STRIP,0,4),null},cleanUp:function(){e.deleteFramebuffer(g),e.deleteTexture(m),e.deleteProgram(f),e.deleteShader(l)},getStageName:function(){return WEBGL_SOFTMAX_STAGE_NAME}}}function buildWebGL2Pipeline(e,t,n,r,a,o){const i=r.getContext("2d"),u=new OffscreenCanvas(r.width,r.height),s=glsl(_a7||(_a7=__template(["#version 300 es\n\n    in vec2 a_position;\n    in vec2 a_texCoord;\n\n    out vec2 v_texCoord;\n\n    void main() {\n      gl_Position = vec4(a_position, 0.0, 1.0);\n      v_texCoord = a_texCoord;\n    }\n  "]))),{width:c,height:l}=e,[f,d]=INPUT_RESOLUTION_PER_MODEL[n.model],m=u.getContext("webgl2"),g=compileShader(m,m.VERTEX_SHADER,s),_=m.createVertexArray();m.bindVertexArray(_);const p=m.createBuffer();m.bindBuffer(m.ARRAY_BUFFER,p),m.bufferData(m.ARRAY_BUFFER,new Float32Array([-1,-1,1,-1,-1,1,1,1]),m.STATIC_DRAW);const E=m.createBuffer();m.bindBuffer(m.ARRAY_BUFFER,E),m.bufferData(m.ARRAY_BUFFER,new Float32Array([0,0,1,0,0,1,1,1]),m.STATIC_DRAW);const h=m.createTexture();m.bindTexture(m.TEXTURE_2D,h),m.texParameteri(m.TEXTURE_2D,m.TEXTURE_WRAP_S,m.CLAMP_TO_EDGE),m.texParameteri(m.TEXTURE_2D,m.TEXTURE_WRAP_T,m.CLAMP_TO_EDGE),m.texParameteri(m.TEXTURE_2D,m.TEXTURE_MIN_FILTER,m.NEAREST),m.texParameteri(m.TEXTURE_2D,m.TEXTURE_MAG_FILTER,m.NEAREST);const T=createTexture(m,m.RGBA8,f,d),A=createTexture(m,m.RGBA8,c,l),v=buildResizingStage(m,g,p,E,n,a),R=n.model.startsWith("meet")?buildSoftmaxStage(m,g,p,E,n,a,T):buildLoadSegmentationStage(m,g,p,E,n,a,T),b=buildJointBilateralFilterStage(m,g,p,E,T,n,A,u),S="blur"===t.type?buildBackgroundBlurStage(m,g,p,E,A,u):buildBackgroundImageStage(m,p,E,A,t.url||null,u);return{render:async function(){m.activeTexture(m.TEXTURE0),m.bindTexture(m.TEXTURE_2D,h),m.texImage2D(m.TEXTURE_2D,0,m.RGBA,m.RGBA,m.UNSIGNED_BYTE,await e.readBitmap()),m.bindVertexArray(_),await v.render(),o(),a.run(),o(),R.render(),b.render(),S.render(),i.drawImage(u,0,0)},updatePostProcessingConfig:function(e){if(b.updateSigmaSpace(e.jointBilateralFilter.sigmaSpace),b.updateSigmaColor(e.jointBilateralFilter.sigmaColor),"image"===t.type){const t=S;t.updateCoverage(e.coverage),t.updateLightWrapping(e.lightWrapping),t.updateBlendMode(e.blendMode)}else if("blur"===t.type)S.updateCoverage(e.coverage);else{const e=S;e.updateCoverage([0,.9999]),e.updateLightWrapping(0)}},cleanUp:function(){S.cleanUp(),b.cleanUp(),R.cleanUp(),v.cleanUp(),m.deleteTexture(A),m.deleteTexture(T),m.deleteTexture(h),m.deleteBuffer(E),m.deleteBuffer(p),m.deleteVertexArray(_),m.deleteShader(g)}}}var _a8,_b3,_a9,_a10,_a11,_b4,_a12,RADIUS=3;function buildBlemishSmoothingStage(e,t,n,r,a,o){const i=glsl(_a8||(_a8=__template(["#version 300 es\n          in vec2 a_position;\n          in vec2 a_texCoord;\n  \n          out vec2 v_texCoord;\n  \n          void main() {\n              // Flipping Y is required when rendering to canvas\n              gl_Position = vec4(a_position, 0.0, 1.0);\n              // gl_Position = vec4(a_position, 0.0, 1.0);\n              v_texCoord = a_texCoord;\n          }\n      "]))),u=glsl(_b3||(_b3=__template(["#version 300 es\n          precision highp float;\n\n          // Input frame is from the previous step\n          uniform sampler2D u_inputFrame;\n          uniform sampler2D u_personMask;\n  \n          uniform vec2 u_texelSize;\n          uniform float u_step;\n          uniform float u_radius;\n          uniform float u_sigmaTexel;\n          uniform float u_sigmaColor;\n  \n          in vec2 v_texCoord;\n  \n          out vec4 outColor;\n  \n          float gaussian(float x, float sigma) {\n              float coeff = -0.5 / (sigma * sigma * 4.0 + 1.0e-6);\n              return exp((x * x) * coeff);\n          }\n  \n          void main() {\n              vec2 centerCoord = v_texCoord;\n              vec3 centerColor = texture(u_inputFrame, centerCoord).rgb;\n  \n              float personMask = texture(u_personMask, v_texCoord).a;\n  \n              float spaceWeight = 0.0;\n              float colorWeight = 0.0;\n              float totalWeight = 0.0;\n              vec3 newVal = vec3(0.0,0.0,0.0);\n  \n              // Subsample kernel space\n              for (float i = -u_radius; i <= u_radius; i += u_step) {\n                  for (float j = -u_radius; j <= u_radius; j += u_step) {\n                      vec2 shift = vec2(j, i) * u_texelSize;\n                      vec2 coord = centerCoord + shift;\n                      vec3 frameColor = texture(u_inputFrame, coord).rgb;\n          \n                      spaceWeight = gaussian(distance(centerCoord, coord), u_sigmaTexel);\n                      colorWeight = gaussian(distance(centerColor, frameColor), u_sigmaColor);\n                      totalWeight += spaceWeight * colorWeight;\n          \n                      newVal += spaceWeight * colorWeight * frameColor;\n                  }\n              }\n              \n              newVal /= totalWeight;\n              outColor = vec4(centerColor * (1.0 - personMask) + newVal * personMask, 1.0);\n          }\n      "]))),[s,c]=INPUT_RESOLUTION_PER_MODEL[o.model],{width:l,height:f}=a,d=1/f,m=1/l,g=compileShader(e,e.VERTEX_SHADER,i),_=compileShader(e,e.FRAGMENT_SHADER,u),p=createPipelineStageProgram(e,g,_,t,n),E=e.getUniformLocation(p,"u_inputFrame"),h=e.getUniformLocation(p,"u_personMask"),T=e.getUniformLocation(p,"u_texelSize"),A=e.getUniformLocation(p,"u_step"),v=e.getUniformLocation(p,"u_radius"),R=e.getUniformLocation(p,"u_sigmaTexel"),b=e.getUniformLocation(p,"u_sigmaColor"),S=e.createFramebuffer(),C=createTexture(e,e.RGBA8,l,f);function F(t){const n=t*Math.max(l/s,f/c),r=Math.max(m,d)*n;e.useProgram(p),e.uniform1f(R,r)}function P(t){e.useProgram(p),e.uniform1f(b,t)}function x(t){const n=t*Math.max(l/s,f/c),r=n/5;e.useProgram(p),e.uniform1f(v,n),e.uniform1f(A,r)}return e.bindFramebuffer(e.FRAMEBUFFER,S),e.framebufferTexture2D(e.FRAMEBUFFER,e.COLOR_ATTACHMENT0,e.TEXTURE_2D,C,0),e.useProgram(p),e.uniform1i(h,1),e.uniform2f(T,m,d),F(0),P(0),x(RADIUS),{render:function(){return e.viewport(0,0,l,f),e.useProgram(p),e.activeTexture(e.TEXTURE1),e.bindTexture(e.TEXTURE_2D,r),getAssignedLocationForPreviousResult(e,E),e.bindFramebuffer(e.FRAMEBUFFER,S),e.drawArrays(e.TRIANGLE_STRIP,0,4),C},getStageName:function(){return WEBGL_BLEMISH_SMOOTHING_STAGE_NAME},updateSigmaSpace:F,updateSigmaColor:P,updateRadius:x,cleanUp:function(){e.deleteTexture(C),e.deleteFramebuffer(S),e.deleteProgram(p),e.deleteShader(_)}}}function buildContrastAdjustmentsStage(e,t,n,r,a){const o=glsl(_a9||(_a9=__template(["#version 300 es\n\n    precision highp float;\n\n    uniform sampler2D u_inputFrame;\n    uniform float u_contrastAdjustment;\n\n    in vec2 v_texCoord;\n\n    out vec4 outColor;\n\n    vec3 adjustColorContrast(vec3 frameColor, float contrastAdjustment) {\n      return 0.5 + (1.0 + contrastAdjustment) * (frameColor - 0.5);\n    }\n    \n    void main() {\n      vec4 frameColor = texture(u_inputFrame, v_texCoord);\n      float frameAlpha = frameColor.a;\n      \n      vec3 updatedFrameContrastColor = adjustColorContrast(frameColor.rgb, u_contrastAdjustment);\n\n      outColor = vec4(updatedFrameContrastColor, frameAlpha);\n    }\n  "]))),{width:i,height:u}=a,s=compileShader(e,e.FRAGMENT_SHADER,o),c=createPipelineStageProgram(e,t,s,n,r),l=e.getUniformLocation(c,"u_inputFrame"),f=e.getUniformLocation(c,"u_contrastAdjustment");e.useProgram(c),e.uniform1i(l,8);const d=e.createFramebuffer(),m=createTexture(e,e.RGBA8,i,u);function g(t){e.useProgram(c),e.uniform1f(f,t)}return e.bindFramebuffer(e.FRAMEBUFFER,d),e.framebufferTexture2D(e.FRAMEBUFFER,e.COLOR_ATTACHMENT0,e.TEXTURE_2D,m,0),g(0),{cleanUp:function(){e.deleteFramebuffer(d),e.deleteProgram(c),e.deleteShader(s),e.deleteShader(t)},render:function(){return e.viewport(0,0,i,u),e.useProgram(c),e.bindFramebuffer(e.FRAMEBUFFER,d),e.drawArrays(e.TRIANGLE_STRIP,0,4),m},updateContrastAdjustment:g,getStageName:function(){return WEBGL_CONTRAST_STAGE_NAME}}}function buildLowLightAdjustmentsStage(e,t,n,r,a){const o=glsl(_a10||(_a10=__template(["#version 300 es\n\n    precision highp float;\n\n    uniform sampler2D u_inputFrame;\n    uniform float u_brightnessAdjustment;\n\n    in vec2 v_texCoord;\n\n    out vec4 outColor;\n\n    vec3 adjustColorBrightness(vec3 frameColor, float brightnessAdjustment) {\n      return frameColor + brightnessAdjustment;\n    }\n    \n    void main() {\n      vec4 frameColor = texture(u_inputFrame, v_texCoord);\n      float frameAlpha = frameColor.a;\n\n      vec3 updatedFrameBrightnessColor = adjustColorBrightness(frameColor.rgb, u_brightnessAdjustment);\n\n      outColor = vec4(updatedFrameBrightnessColor, frameAlpha);\n    }\n  "]))),{width:i,height:u}=a,s=compileShader(e,e.FRAGMENT_SHADER,o),c=createPipelineStageProgram(e,t,s,n,r),l=e.getUniformLocation(c,"u_inputFrame"),f=e.getUniformLocation(c,"u_brightnessAdjustment");e.useProgram(c),e.uniform1i(l,8);const d=e.createFramebuffer(),m=createTexture(e,e.RGBA8,i,u);function g(t){e.useProgram(c),e.uniform1f(f,t)}return e.bindFramebuffer(e.FRAMEBUFFER,d),e.framebufferTexture2D(e.FRAMEBUFFER,e.COLOR_ATTACHMENT0,e.TEXTURE_2D,m,0),g(0),{cleanUp:function(){e.deleteFramebuffer(d),e.deleteProgram(c),e.deleteShader(s),e.deleteShader(t)},render:function(){return e.viewport(0,0,i,u),e.useProgram(c),e.bindFramebuffer(e.FRAMEBUFFER,d),e.drawArrays(e.TRIANGLE_STRIP,0,4),m},updateBrightnessAdjustment:g,getStageName:function(){return WEBGL_LOW_LIGHT_STAGE_NAME}}}function writeTextureToCanvasStage(e,t,n,r){const a=glsl(_a11||(_a11=__template(["#version 300 es\n        in vec2 a_position;\n        in vec2 a_texCoord;\n\n        out vec2 v_texCoord;\n\n        void main() {\n            // Flipping Y is required when rendering to canvas\n            // TODO: Revert this comment when we completely move over to the V2 pipeline.\n            // Background image stage for the old version already flips it\n            // gl_Position = vec4(a_position * vec2(1.0, -1.0), 0.0, 1.0);\n            gl_Position = vec4(a_position, 0.0, 1.0);\n            v_texCoord = a_texCoord;\n        }\n    "]))),o=glsl(_b4||(_b4=__template(["#version 300 es\n        precision highp float;\n\n        uniform sampler2D u_previousResult;\n        in vec2 v_texCoord;\n\n        out vec4 outColor;\n\n        void main() {\n            outColor = texture(u_previousResult, v_texCoord).rgba;\n        }\n    "]))),{width:i,height:u}=r,s=compileShader(e,e.VERTEX_SHADER,a),c=compileShader(e,e.FRAGMENT_SHADER,o),l=createPipelineStageProgram(e,s,c,t,n),f=e.getUniformLocation(l,"u_previousResult");return{render:function(){return e.viewport(0,0,i,u),e.useProgram(l),getAssignedLocationForPreviousResult(e,f),e.bindFramebuffer(e.FRAMEBUFFER,null),e.drawArrays(e.TRIANGLE_STRIP,0,4),null},cleanUp:function(){e.deleteProgram(l),e.deleteShader(c)},getStageName:function(){return WEBGL_WRITE_TO_CANVAS_STAGE_NAME}}}function buildWebGL2PipelineSequentialStaging(e,t,n,r,a,o,i,u,s,c){const l=[],f=r.getContext("2d"),d=new OffscreenCanvas(r.width,r.height),m=glsl(_a12||(_a12=__template(["#version 300 es\n\n    in vec2 a_position;\n    in vec2 a_texCoord;\n\n    out vec2 v_texCoord;\n\n    void main() {\n      gl_Position = vec4(a_position, 0.0, 1.0);\n      v_texCoord = a_texCoord;\n    }\n  "]))),{width:g,height:_}=e,[p,E]=INPUT_RESOLUTION_PER_MODEL[n.model],h=d.getContext("webgl2"),T=compileShader(h,h.VERTEX_SHADER,m),A=h.createVertexArray();h.bindVertexArray(A);const v=h.createBuffer();h.bindBuffer(h.ARRAY_BUFFER,v),h.bufferData(h.ARRAY_BUFFER,new Float32Array([-1,-1,1,-1,-1,1,1,1]),h.STATIC_DRAW);const R=h.createBuffer();h.bindBuffer(h.ARRAY_BUFFER,R),h.bufferData(h.ARRAY_BUFFER,new Float32Array([0,0,1,0,0,1,1,1]),h.STATIC_DRAW);const b=h.createTexture();h.bindTexture(h.TEXTURE_2D,b),h.texParameteri(h.TEXTURE_2D,h.TEXTURE_WRAP_S,h.CLAMP_TO_EDGE),h.texParameteri(h.TEXTURE_2D,h.TEXTURE_WRAP_T,h.CLAMP_TO_EDGE),h.texParameteri(h.TEXTURE_2D,h.TEXTURE_MIN_FILTER,h.NEAREST),h.texParameteri(h.TEXTURE_2D,h.TEXTURE_MAG_FILTER,h.NEAREST);const S=createTexture(h,h.RGBA8,p,E),C=createTexture(h,h.RGBA8,g,_);let F;const P=buildResizingStage(h,T,v,R,n,a),x=n.model.startsWith("meet")?buildSoftmaxStage(h,T,v,R,n,a,S):buildLoadSegmentationStage(h,T,v,R,n,a,S),y=buildJointBilateralFilterStage(h,T,v,R,S,n,C,d),w="blur"===t.type?buildBackgroundBlurStage(h,T,v,R,C,d):buildBackgroundImageStage(h,v,R,C,t.url||null,d),U=u?buildLowLightAdjustmentsStage(h,T,v,R,d):null,M=s?buildContrastAdjustmentsStage(h,T,v,R,d):null,I=i?buildBlemishSmoothingStage(h,v,R,C,d,n):null;return l.push(U,M,I,{render:w.renderToTexture,cleanUp:w.cleanUp,getStageName:()=>WEBGL_RENDER_BACKGROUND_TO_TEXTURE_STAGE_NAME},writeTextureToCanvasStage(h,v,R,r)),{render:async function(t=!1){const n=performance.now();h.activeTexture(h.TEXTURE0),h.bindTexture(h.TEXTURE_2D,b),h.texImage2D(h.TEXTURE_2D,0,h.RGBA,h.RGBA,h.UNSIGNED_BYTE,await e.readBitmap()),h.bindVertexArray(A),await P.render(),o();const r=performance.now();await a.run(),t&&(null==c||c(performance.now()-r,WEBGL_SEGMENTATION_TFLITE_STAGE_NAME)),o(),x.render(),y.render(),allocateUnitForPreviousTexture(h,b),l.forEach((e=>{F=null==e?void 0:e.render(),F&&allocateUnitForPreviousTexture(h,F)})),f.drawImage(d,0,0),t&&(null==c||c(performance.now()-n,WEBGL_STAGE_COMPLETE))},updateBrightnessAdjustment:function(e){var t,n;u&&(null==(t=null==U?void 0:U.updateBrightnessAdjustment)||t.call(U,e)),s&&(null==(n=null==M?void 0:M.updateContrastAdjustment)||n.call(M,BRIGHTNESS_TO_CONTRAST_RATIO*e))},updatePostProcessingConfig:function(e){var n,r;if(y.updateSigmaSpace(e.jointBilateralFilter.sigmaSpace),y.updateSigmaColor(e.jointBilateralFilter.sigmaColor),null==(n=null==I?void 0:I.updateSigmaSpace)||n.call(I,e.blemishSmoothingFilter.sigmaSpace),null==(r=null==I?void 0:I.updateSigmaColor)||r.call(I,e.blemishSmoothingFilter.sigmaColor),"image"===t.type){const t=w;t.updateCoverage(e.coverage),t.updateLightWrapping(e.lightWrapping),t.updateBlendMode(e.blendMode)}else if("blur"===t.type)w.updateCoverage(e.coverage);else{const e=w;e.updateCoverage([0,.9999]),e.updateLightWrapping(0)}},cleanUp:function(){l.forEach((e=>null==e?void 0:e.cleanUp())),y.cleanUp(),x.cleanUp(),P.cleanUp(),h.deleteTexture(C),h.deleteTexture(S),h.deleteTexture(b),F&&h.deleteTexture(F),h.deleteBuffer(R),h.deleteBuffer(v),h.deleteVertexArray(A),h.deleteShader(T)}}}var FPS_REPORT_INTERVAL_MS=1e3,MAX_FPS_CAP=30,RequestChannel=class{constructor(e){this.port=e,this.pendingRequests={},this.requestCb={},e.onmessage=e=>{const t=this.requestCb[e.data.type];t&&t(e.data),this.fulfillPendingRequest(e)}}on(e,t){this.requestCb[e]=t}send(e){const t=e.responseType&&this.pendingRequests[e.responseType];if(t)return t.promise;this.port.postMessage(__spreadValues({type:e.requestType},"object"==typeof e.data?e.data:{}));let n,r;const a=new Promise(((e,t)=>{n=e,r=t}));return e.responseType&&(this.pendingRequests[e.responseType]={promise:a,resolve:n,reject:r}),a}fulfillPendingRequest(e){const t=e.data.type,n=this.pendingRequests[t];n&&(n.resolve(e.data),this.pendingRequests[t]=void 0)}},RenderingLoop=class{constructor(e,t){this.pipeline=e,this.requestChannel=t,this.frameCount=0,this.previousTimeMs=Date.now(),this.stopped=!1}start(){this.render()}stop(){this.stopped=!0,this.pipeline.cleanUp()}updateBrightnessAdjustment(e){var t,n;null==(n=null==(t=this.pipeline)?void 0:t.updateBrightnessAdjustment)||n.call(t,e)}endFrame(){const e=Date.now();if(this.frameCount++,e>=this.previousTimeMs+FPS_REPORT_INTERVAL_MS){const t=Math.round(this.frameCount*FPS_REPORT_INTERVAL_MS/(e-this.previousTimeMs));this.requestChannel.send({requestType:"report-fps",data:{fps:t}}),this.previousTimeMs=e,this.frameCount=0}}async render(){if(this.stopped)return;let e=Math.round(1e3/MAX_FPS_CAP);const t=performance.now();await this.pipeline.render(),this.endFrame(),e=Math.max(0,e-(performance.now()-t)),setTimeout((async()=>{await this.render()}),e)}},WorkerServer=class e{constructor(e){this.args=e,this.adjustmentIntervalId=null,this.brightnessAdjustment=0,this.previousBrightnessPercentage=-1/0;const{background:t,segmentationConfig:n,postProcessingConfig:r,segmenter:a,renderTarget:o,requestChannel:i,sourceInfo:u,useV2SequentialPipeline:s,withContrastAdjustments:c,withLowLightAdjustments:l}=e,f=this.createFrameProvider(u),d=s?buildWebGL2PipelineSequentialStaging(f,toBackgroundConfig(t),n,o,a,(()=>{}),!1,l,c):buildWebGL2Pipeline(f,toBackgroundConfig(t),n,o,a,(()=>{}));d.updatePostProcessingConfig(r),this.requestChannel=i,this.renderingLoop=new RenderingLoop(d,this.requestChannel),this.requestChannel.on("stop",this.stop.bind(this)),l&&this.createAdjustmentIntervalId(f,r.brightnessThresholds)}start(){this.renderingLoop.start()}stop(){this.renderingLoop.stop()}rebuild(t){const{background:n,postProcessingConfig:r,useV2SequentialPipeline:a,withContrastAdjustments:o,withLowLightAdjustments:i}=t;return this.stop(),this.clearAdjustmentInterval(),new e(__spreadProps(__spreadValues({},this.args),{background:n||this.args.background,postProcessingConfig:r||this.args.postProcessingConfig,useV2SequentialPipeline:"boolean"==typeof a?a:this.args.useV2SequentialPipeline,withContrastAdjustments:"boolean"==typeof o?o:this.args.withContrastAdjustments,withLowLightAdjustments:"boolean"==typeof i?i:this.args.withLowLightAdjustments}))}clearAdjustmentInterval(){this.adjustmentIntervalId&&(clearInterval(this.adjustmentIntervalId),this.adjustmentIntervalId=null,this.previousBrightnessPercentage=-1/0,this.brightnessAdjustment=0)}createAdjustmentIntervalId(e,t){this.clearAdjustmentInterval();const n=setInterval((async()=>{const n=calculateBrightnessPercentage(await e.readArrayBuffer()),{increment:r}=getCurrentBrightnessAdjustment(n,t);r!==this.brightnessAdjustment&&shouldUpdateBrightnessAdjustmentRelativeToLastUpdate(n,this.previousBrightnessPercentage)&&(this.previousBrightnessPercentage=n,this.brightnessAdjustment=r,this.renderingLoop.updateBrightnessAdjustment(r))}),LOW_LIGHT_TIMEOUT_MS);this.adjustmentIntervalId=n}createFrameProvider(e){return{readBitmap:async()=>(await this.requestChannel.send({requestType:"pull-frame-bitmap",responseType:"push-frame-bitmap",onReject:t=>(this.requestChannel.send({requestType:"error",data:{error:t}}),this.stop(),createImageBitmap(new ImageData(e.width,e.height)))})).frame,readArrayBuffer:async()=>new Uint8ClampedArray((await this.requestChannel.send({requestType:"pull-frame-array-buffer",responseType:"push-frame-array-buffer",onReject:t=>(this.requestChannel.send({requestType:"error",data:{error:t}}),this.stop(),new Uint8ClampedArray(e.width*e.height*4))})).frame),width:e.width,height:e.height}}},segmenter=null,server=null;self.onconnect=function(e){let t=buildSegmentationConfig({});segmenter=null!=segmenter?segmenter:buildSegmenter(t);const n=e.ports[0],r=new RequestChannel(n);r.on("set-render-target",(async e=>{if(!segmenter)throw new Error("failed to create segmenter");JSON.stringify(t)!==JSON.stringify(e.background.segmentationConfig)&&(t=e.background.segmentationConfig,segmenter=buildSegmenter(t)),server&&server.clearAdjustmentInterval(),server&&server.stop(),(server=new WorkerServer({background:e.background.selected,segmentationConfig:e.background.segmentationConfig,postProcessingConfig:e.background.postProcessingConfig,segmenter:await segmenter,renderTarget:e.renderTarget,requestChannel:r,sourceInfo:e.sourceInfo,withContrastAdjustments:e.featureFlags.withContrastAdjustments,withLowLightAdjustments:e.featureFlags.withLowLightAdjustments,useV2SequentialPipeline:e.featureFlags.useV2SequentialPipeline})).start()})),r.on("set-background-settings",(e=>{server?(server=server.rebuild(e)).start():r.send({requestType:"error",data:{message:"Invalid request, server hasn't been initialized yet"}})})),r.on("set-post-processing-config",(e=>{server?(server=server.rebuild(e)).start():r.send({requestType:"error",data:{message:"Invalid request, server hasn't been initialized yet"}})})),r.on("set-worker-state",(e=>{server?(server=server.rebuild(e)).start():r.send({requestType:"error",data:{message:"Invalid request, server hasn't been initialized yet"}})}))};
!function(){try{var e="undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof globalThis?globalThis:"undefined"!=typeof self?self:{},n=(new e.Error).stack;n&&(e._sentryDebugIds=e._sentryDebugIds||{},e._sentryDebugIds[n]="dcc08e2a-fb3b-5272-bbf4-2edec01fc356")}catch(e){}}();
//# debugId=dcc08e2a-fb3b-5272-bbf4-2edec01fc356
